# pfsense DHCP deaktivieren

Unserere Distributions-VM 'centos' wird diese Funktion übernehmen, deshalb auf pfsense abschalten.

```plaintext
webConfigurator http://192.168.100.2/
Services > DHCP Server > LAN > General DHCP Options
```
- [ ] Enable DHCP server on LAN interface

# Ansible

## Ansible implementieren

Es gibt 2 Arten von Ansible Teilnehmern:

* **Control Station**  = die Haupt-VM von welcher wir verteilen
* **Clients** = alle anderen VMs

## PXE Server via Ansible implementieren

Um CentOS als PXE-Server mit Ansible zu konfigurieren, müssen Sie mehrere Schritte durchführen. Diese Einrichtung umfasst die Installation der erforderlichen Pakete, die Konfiguration der DHCP- und TFTP-Dienste sowie die Einrichtung der PXE-Boot-Umgebung.

## Schritt-für-Schritt-Anleitung

1. **Installieren der erforderlichen Pakete**:
   Sie müssen `dnsmasq` für die DHCP- und TFTP-Serverfunktionalität sowie `syslinux` für die PXE-Boot-Dateien installieren.

2. **Konfigurieren von DHCP und TFTP**:
   Sie müssen `dnsmasq` so einrichten, dass es DHCP-Dienste bereitstellt und konfiguriert ist, um PXE-Dateien über TFTP zu bedienen.

3. **Einrichten des TFTP-Bootverzeichnisses**:
   Sie müssen die Kernel- und Initrd-Bilder kopieren und die PXE-Bootkonfigurationsdateien einrichten.

4. **Starten und Aktivieren der Dienste**:
   Stellen Sie sicher, dass `dnsmasq` aktiviert und gestartet ist, damit es beim Booten ausgeführt wird.

## Ansible-Pakete auf CentOS Control Station installieren

```bash
sudo yum update -y
```
```bash
sudo yum install epel-release -y
```
```bash
sudo yum install ansible -y
```
```bash
ansible --version
```

```bash
[lucian@centos ~]$ ansible --version
ansible [core 2.14.17]
  config file = /etc/ansible/ansible.cfg  <---- Konfigurationsordner
  configured module search path = ['/home/lucian/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3.9/site-packages/ansible
  ansible collection location = /home/lucian/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/bin/ansible
  python version = 3.9.20 (main, Sep  9 2024, 00:00:00) [GCC 11.5.0 20240719 (Red Hat 11.5.0-2)] (/usr/bin/python3)
  jinja version = 3.1.2
  libyaml = True
```

Die Konfigurationsdateien sind im Ordner /etc/ansible/

```bash
cd /etc/ansible/ && ll
```
```bash
[lucian@centos ~]$ cd /etc/ansible/
[lucian@centos ansible]$ ls -l
total 8
-rw-r--r--. 1 root root  614 May 23 21:53 ansible.cfg
-rw-r--r--. 1 root root 1175 May 23 21:53 hosts
drwxr-xr-x. 2 root root    6 May 23 21:53 roles
[lucian@centos ansible]$
```

* **ansible.cfg**: Konfigurationseinstellungen für Ansible.
* **hosts**: Inventardatei, die verwaltete Hosts auflistet.
* **roles**: Verzeichnis zur Organisation wiederverwendbarer Ansible-Rollen.

## In der ansible.cfg das Attribut 'host_key_checking' deaktivieren

In der Produktion wird sowas benutzt, in Testumgebungen nicht nötig. 

Nano Texteditor hinzufügen:
```bash
sudo yum install nano
```
```bash
sudo nano ansible.cfg
```

Diese Zeilen hinzufügen:

```plaintext
[defaults]
host_key_checking = False
```

`Ctrl+O zum speichern`
`Ctrl+X um zu schliessen`

Alternative (falls nicht schon da, die 2 Linien hinzufügen): 
```bash
grep -qxF "[defaults]" /etc/ansible/ansible.cfg || (echo -e "[defaults]\nhost_key_checking = False" | sudo tee -a /etc/ansible/ansible.cfg)
```

* Wenn host_key_checking auf False gesetzt ist, deaktiviert Ansible die Überprüfung des SSH-Hostschlüssels, wenn es sich mit einem Remote-Host verbindet. Standardmäßig überprüft SSH, ob der Hostschlüssel eines Servers, mit dem Sie eine Verbindung herstellen, in der Datei known_hosts vorhanden ist. Wenn der Schlüssel nicht übereinstimmt oder nicht vorhanden ist, wird eine Warnung angezeigt, und die Verbindung wird möglicherweise abgelehnt.

## Inventar-Liste vorbereiten

Hier notieren wir unsere VMs laut lokale Namensauflösung (/etc/hosts) - die 2 localhost Einträge lassen wir raus:

```plaintext
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.100.2    pfsense
192.168.100.3    snort
192.168.100.10   centos
192.168.100.11   ubuntu
192.168.100.12   fedora
192.168.100.13   debian
192.168.100.14   kali
```

Liste im Ansible-Format erstellen:

```bash
sudo nano hosts
```
```plaintext
[firewall]
pfsense		ansible_host=192.168.100.2 ansible_user=admin

[clients]
centos		ansible_host=192.168.100.10 ansible_user=lucian
ubuntu		ansible_host=192.168.100.11 ansible_user=lucian
fedora		ansible_host=192.168.100.12 ansible_user=lucian
debian		ansible_host=192.168.100.13 ansible_user=lucian
kali		ansible_host=192.168.100.14 ansible_user=lucian
```
`Ctrl+O zum speichern`
`Ctrl+X um zu schliessen`

## Playbooks Ordner erstellen

In diesen Ordner werden wir die Playbooks platzieren:

```bash
mkdir /etc/ansible/playbooks
```
```bash
[lucian@centos ansible]$ ls -l
total 8
-rw-r--r--. 1 root root  652 Oct 28 00:37 ansible.cfg
-rw-r--r--. 1 root root 1530 Oct 28 00:41 hosts
drwxr-xr-x. 2 root root    6 Oct 28 01:16 playbooks  <----
drwxr-xr-x. 2 root root    6 May 23 21:53 roles
```
```bash
cd /etc/ansible/playbooks
```

## PXE Playbook erstellen

```bash
sudo touch ansible-pxe-setup.yml
```
```bash
sudo nano ansible-pxe-setup.yml
```
```plaintext
---
- hosts: centos
  become: true
  tasks:
    - name: Install necessary packages
      yum:
        name:
          - dhcp-server
          - tftp-server
          - syslinux
          - httpd
          - vsftpd
        state: present

    - name: Enable and start services
      service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - dhcpd
        - tftp
        - httpd

    - name: Configure DHCP server
      copy:
        dest: /etc/dhcp/dhcpd.conf
        content: |
          option domain-name "localdomain";
          option domain-name-servers 8.8.8.8, 8.8.4.4;
          default-lease-time 600;
          max-lease-time 7200;
          subnet 192.168.100.0 netmask 255.255.255.0 {
            range 192.168.100.50 192.168.100.100;
            option routers 192.168.100.2;
            filename "pxelinux.0";
            next-server 192.168.100.10;
          }

    - name: Configure TFTP server
      copy:
        dest: /etc/xinetd.d/tftp
        content: |
          service tftp
          {
              socket_type     = dgram
              protocol        = udp
              wait            = yes
              user            = root
              server          = /usr/sbin/in.tftpd
              server_args     = -s /var/lib/tftpboot
              disable         = no
          }
      notify: Restart xinetd

    - name: Create TFTP boot directory
      file:
        path: /var/lib/tftpboot
        state: directory
        mode: '0755'

    - name: Copy PXE boot files
      copy:
        src: /usr/share/syslinux/pxelinux.0
        dest: /var/lib/tftpboot/pxelinux.0

    - name: Configure HTTP server to serve installation media
      shell: |
        mkdir -p /var/www/html/centos
        mount -o loop /path/to/CentOS-Stream-9-latest-x86_64-dvd1.iso /var/www/html/centos
      args:
        creates: /var/www/html/centos

    - name: Configure firewall
      firewalld:
        service: "{{ item }}"
        permanent: true
        state: enabled
      loop:
        - dhcp
        - tftp
        - http
      notify: Reload firewalld

  handlers:
    - name: Restart xinetd
      service:
        name: xinetd
        state: restarted

    - name: Reload firewalld
      service:
        name: firewalld
        state: reloaded
```
`Ctrl+O zum speichern`
`Ctrl+X um zu schliessen`

## PXE Playbook ausführen
```bash
ansible-playbook -i /path/to/inventory pxe_setup.yml
```


























## SSH Schlüsselpaar erstellen

```bash
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -C "lab"
```
`Enter`
`Enter`

Schlüsselpaar:

```plaintext
ls -l ~/.ssh/id_rsa
```
```plaintext
ls -l ~/.ssh/id_rsa.pub
```

## Verteile den Public-Schlüssel auf alle anderen VMs

```bash
ssh-copy-id admin@192.168.100.2
```
```bash
ssh-copy-id lucian@192.168.100.10
```
```bash
ssh-copy-id lucian@192.168.100.11
```
```bash
ssh-copy-id lucian@192.168.100.12
```
```bash
ssh-copy-id lucian@192.168.100.13
```
```bash
ssh-copy-id lucian@192.168.100.14
```
