# 1. pfSense VM installieren (PXE Server)

VM Profil erstellen:
```powershell
"C:\lab\vm\ps-scripts\0. pfsense-vm.ps1"
```
Danach die Anweisungen hier befolgen: [4. pfSense - Firewall Implementieren.md](https://github.com/luki4no/lab/blob/main/4.%20pfSense%20-%20Firewall%20Implementieren.md)

pfSense Backup ist hier zu finden: [config-pfSense.home.arpa-20241111113220.xml](https://github.com/luki4no/lab/blob/main/vm/backup/config-pfSense.home.arpa-20241111113220.xml)

# 2. ISO-Images herunterladen und auf pfsense transferieren

Ordnerstruktur erstellen:
```powershell
ssh admin@192.168.100.2 "mkdir -p /usr/local/www/pxe/iso /usr/local/www/pxe/automation /usr/local/www/pxe/centos /usr/local/www/pxe/fedora /usr/local/www/pxe/ubuntu /usr/local/www/pxe/debian /usr/local/www/pxe/kali; chown -R root:www /usr/local/www/pxe; chmod -R 755 /usr/local/www/pxe"
```

Automatisierungsdateien transferieren:
```powershell
scp -r "C:\lab\vm\automation\*" admin@192.168.100.2:/usr/local/www/pxe/automation
```

ISO-Download-Skript transferieren:
```powershell
scp "C:\lab\vm\ps-scripts\download-iso.sh" admin@192.168.100.2:/usr/local/www/pxe/iso; ssh admin@192.168.100.2 chmod +x /usr/local/www/pxe/iso/download-iso.sh
```

ISO-Images herunterladen:

Einzeln:
```powershell
ssh admin@192.168.100.2 /usr/local/www/pxe/iso/download-iso.sh
```
Alle:
```powershell
ssh admin@192.168.100.2 "echo 6 | /usr/local/www/pxe/iso/download-iso.sh"
```

```bash
[2.7.2-RELEASE][admin@pfSense.home.arpa]/root: /usr/local/www/pxe/iso/download-iso.sh
Please select which ISO image you want to download:
1. RedHat - CentOS (Stream 9)
2. Debian - Ubuntu Server (24.04.1)
3. RedHat - Fedora Server (41-1.4)
4. Debian - Debian (12.8.0)
5. Debian - Kali (2024.3)
6. >>> Download All VMs <<<   <---- 
7. Exit

Enter the number of your choice (1-7):
```
```powershell
ssh admin@192.168.100.2 ls -l /usr/local/www/pxe/iso/
```

ISO-Images entpacken:
```powershell
ssh admin@192.168.100.2 bsdtar -C /usr/local/www/pxe/centos -xf /usr/local/www/pxe/iso/CentOS-Stream-9-latest-x86_64-dvd1.iso
```
```powershell
ssh admin@192.168.100.2 bsdtar -C /usr/local/www/pxe/ubuntu -xf /usr/local/www/pxe/iso/ubuntu-24.04.1-live-server-amd64.iso
```
```powershell
ssh admin@192.168.100.2 bsdtar -C /usr/local/www/pxe/fedora -xf /usr/local/www/pxe/iso/Fedora-Server-dvd-x86_64-41-1.4.iso
```
```powershell
ssh admin@192.168.100.2 bsdtar -C /usr/local/www/pxe/debian -xf /usr/local/www/pxe/iso/debian-12.8.0-amd64-netinst.iso
```
```powershell
ssh admin@192.168.100.2 bsdtar -C /usr/local/www/pxe/kali -xf /usr/local/www/pxe/iso/kali-linux-2024.3-installer-netinst-amd64.iso
```

Permissions/Ownership:
```powershell
ssh admin@192.168.100.2 "chown -R root:www /usr/local/www/pxe/ && chmod -R 755 /usr/local/www/pxe/"
```
```powershell
ssh admin@192.168.100.2 ls -l /usr/local/www/pxe/
```

# 3. Die restlichen VMs installieren

## Option 1 Manuell: VM Profile mittels PowerShell erstellen und OS manuell installieren 

Zuerst VM Profile erstellen (ISO-Image wird automatisch angehÃ¤ngt und gemountet):
```powershell
C:\lab\vm\ps-scripts\create-all-vms.ps1
```
```powershell
PS C:\lab\vm\ps-scripts> C:\lab\vm\ps-scripts\create-all-vms.ps1

This script will create the Hyper-V VM profile(s), and mount the corresponding ISO-image

Please choose an option:
1. RedHat - CentOS (Stream 9)
2. Debian - Ubuntu Server (24.04.1)
3. RedHat - Fedora Server (41-1.4)
4. Debian - Debian (12.7.0)
5. Debian - Kali (2024.3)
6. >>> Install All VMs <<<
7. Exit
Enter the number of your choice:
```
Danach die VM starten und die Einstellungen manuell setzen.

## Option 2 PXE: VM Profile mittels PowerShell erstellen und die OS-Installation unbeaufsichtigt laufen lassen

Zuerst VM Profile erstellen (ohne ISO-Image, Netzwerkboot):
```powershell
C:\lab\vm\ps-scripts\create-all-vms-pxe.ps1
```
```powershell
PS C:\lab\vm\ps-scripts> C:\lab\vm\ps-scripts\create-all-vms-pxe.ps1

This script will create the Hyper-V VM profile(s), for unattended PXE installations

Please choose an option:
1. RedHat - CentOS (Stream 9)
2. Debian - Ubuntu Server (24.04.1)
3. RedHat - Fedora Server (41-1.4)
4. Debian - Debian (12.7.0)
5. Debian - Kali (2024.3)
6. >>> Install All VMs <<<
7. Exit
Enter the number of your choice:
```
