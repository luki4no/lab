# Netzwerkadapter (PrivateSwitch) hinzufügen

Virtueller-Switch-Name: `PrivateSwitch`
Netzwerksegment: `192.168.200.0/24`

## Sicherstellen, dass wir den virtuellen Switch 'PrivateSwitch' haben

Dieser wird mittels Powershell-Skript `C:\lab\vm\ps-scripts\create-internal-external-private-switches.ps1` eingebaut.

Bestätigen, dass dieser da is:
```powershell
PS C:\lab\vm\ps-scripts> Get-VMSwitch

Name                   SwitchType NetAdapterInterfaceDescription
----                   ---------- ------------------------------
ExternalSwitch         External   Realtek RTL8852BE WiFi 6 802.11ax PCIe Adapter
PrivateSwitch          Private  <----
NatSwitch              Internal
Default Switch         Internal
WSL (Hyper-V firewall) Internal


PS C:\lab\vm\ps-scripts>
```

Ist dieser nicht vorhanden, dann das obengenante Skript nochmal ausführen.

## In kali VM Netzwerkadapter hinzufügen

Einen neuen Netzwerkadapter hinzuzufügen:
```plaintext
Right click kali VM > Settings
```
1. Hardware
2. Add Hardware
3. Network Adapter
4. Add
5. VirtualSwitch: PrivateSwitch
6. OK

* eth0 soll unser `NatSwitch` Adapter sein
* eth1 soll unser `PrivateSwitch` Adapter sein

Ist die Reihenfolge umgekehrt, dann einfach den zweiten Netzwerkadapter im laufenden Betrieb der kali VM einbinden.

# IP Einstellungen

Bevor:
```bash
ip a
```
* eth0 = `inet 192.168.100.14` (NatSwitch)
* eth0 = `leer`

## Statische IP dem eth1 vergeben

```plaintext
Kali Applications Menu > Advanced Network Configuration
```
1. Links unten auf `+`
2. Choose a Connection Type: `Ethernet`
3. Create...
4. Ethernet
5. Device: `eth1`
6. IPv4 Settings
7. Method: `Manual`
8. Addresses: `Add`
9. Address: `192.168.200.14`
10. Netmask: `24`
11. Gateway: `192.168.200.2` (pfsense `OPT1 (hn2)` Adapter)
12. DNS Servers: `1.1.1.1`
13. Save

- Ethernet
   - Wired connection 1
   - Ethernet connection 1 <---
 
Um die `eth*` Reihenfolge explizit zu definieren hier nochmal auch die Einstellungen beider Profile gehen und unter `Ethernet > Device > eth*` den Adapter manuell setzen.

pfsense `OPT1 (hn2)` Adapter
```plaintext
*** Welcome to pfSense 2.7.2-RELEASE (amd64) on pfSense ***

 WAN (wan)       -> hn0        -> v4/DHCP4: 192.168.1.20/24
                                  v6/SLAAC: 2a00...
 LAN (lan)       -> hn1        -> v4: 192.168.100.2/24
 OPT1 (opt1)     -> hn2        -> v4: 192.168.200.2/24  <---

 0) Logout (SSH only)                  9) pfTop
 1) Assign Interfaces                 10) Filter Logs
 2) Set interface(s) IP address       11) Restart webConfigurator
 3) Reset webConfigurator password    12) PHP shell + pfSense tools
 4) Reset to factory defaults         13) Update from console
 5) Reboot system                     14) Enable Secure Shell (sshd)
 6) Halt system                       15) Restore recent configuration
 7) Ping host                         16) Restart PHP-FPM
 8) Shell
```

Danach:
```bash
ip a
```
* eth0 = `inet 192.168.100.14` (NatSwitch)
* eth0 = `inet 192.168.200.14` (PrivateSwitch)

## Ping test

Der Ping zum Gateway schlägt im Moment fehl (normal):

`kali (eth1) -> pfsense (hn2)`

kali:
```bash
ping -c1 192.168.200.2
```

Andersrum funktioniert es:

`kali (eth1) <- pfsense (hn2)`

pfsense:
```bash
ping -c1 192.168.200.14
```

## pfsense Firewall Regel hinzufügen um die Verbindung temporär freizuschalten

```plaintext
webConfigurator http://192.168.100.2/
Firewall > Rules > OPT1 > Add
```

1. Action: Pass
2. Interface: OPT1
3. Protocol: Any
4. Source: Address or Alias	192.168.200.14  <--- kali eth1 IP
5. Destination: This Firewall (self)
6. Description: Allow config traffic from kali (temp)
7. Save
8. Apply Changes

Diese Regel lässt den Zugriff auf die pfsense webConfigurator Webpage zu
```plaintext
webConfigurator http://192.168.200.2/
```

# kali kann jetzt pfsense pingen:

$ ping 192.168.100.1 <--- OK

```plaintext
webConfigurator http://192.168.200.2/
VPN > OpenVPN > Servers > OpenVPN Servers
```
Hier müssten wir schon ein Profil `mylab_vpn` haben (Unter Punkt `5. pfSense - OpenVPN Server implementieren.md` erstellt).

```plaintext
webConfigurator http://192.168.200.2/
VPN > OpenVPN > Servers > OpenVPN Servers
```






