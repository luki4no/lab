# Abschwächung von Sicherheitsangriffen mit Ansible

Um einen konsistenten Zustand auf allen Maschinen in dieser Umgebung zu gewährleisten, automatisieren wir den Hardening-Prozess mit Ansible.

## **Patching**  
- **Super wichtig**  
  - Systemstabilität und Sicherheitsfixes  
- **Monatliche Updates**  
  - Inkrementell (und wichtig)  
- **Drittanbieter-Updates**  
  - Anwendungsentwickler, Gerätetreiber  
- **Automatische Updates**  
  - Nicht immer die beste Wahl  
- **Notfall-Updates außerhalb des Plans**  
  - Zero-Day-Lücken und wichtige Sicherheitsprobleme  

```yml
- name: System Updates and Patching
  hosts: clients
  tasks:
    - name: Update and upgrade (Debian-based systems)
      apt:
        update_cache: yes
        upgrade: dist
      when: ansible_os_family == "Debian"

    - name: Update all packages (Red Hat-based systems)
      yum:
        name: "*"
        state: latest
      when: ansible_os_family == "RedHat"
```

---

## **Verschlüsselung**  
- **Zugriff auf Anwendungsdaten blockieren**  
  - Dateisystemverschlüsselung  
- **Verschlüsselung der gesamten Festplatte (FDE)**  
  - Alles auf der Festplatte verschlüsseln  
  - BitLocker, FileVault usw.  
- **Dateiebene-Verschlüsselung**  
  - Windows EFS  
- **Anwendungsdatenverschlüsselung**  
  - Von der App verwaltet  
  - Gespeicherte Daten sind geschützt  

```yml
- name: Disk Encryption with LUKS
  hosts: clients
  tasks:
    - name: Install cryptsetup tools
      package:
        name: cryptsetup
        state: present

    - name: Format disk with LUKS encryption
      command: cryptsetup luksFormat /dev/sdb --batch-mode
      when: ansible_os_family in ["RedHat", "Debian"]
```
---

## **Überwachung**  
- **Infos von Geräten sammeln**  
  - Eingebaute Sensoren, externe Geräte  
  - In Server, Switches, Router, Firewalls usw. integriert  
- **Sensoren**  
  - Intrusion-Prevention-Systeme, Firewall-Logs,  
    Authentifizierungsprotokolle, Webserver-Zugriffslogs,  
    Datenbanktransaktionslogs, E-Mail-Logs  
- **Sammelstellen**  
  - Proprietäre Konsolen (IPS, Firewall)  
  - SIEM-Konsolen, Syslog-Server  
  - Viele SIEM-Systeme haben Engines, die Sensordaten vergleichen  

```yml
- name: Install Elastic Agent for Monitoring
  hosts: clients
  tasks:
    - name: Install Elastic Agent (Debian)
      apt:
        name: elastic-agent
        state: latest
      when: ansible_os_family == "Debian"

    - name: Install Elastic Agent (Red Hat)
      yum:
        name: elastic-agent
        state: latest
      when: ansible_os_family == "RedHat"
```
---

## **Minimalprinzip (Least Privilege)**  
- **Rechte und Berechtigungen aufs Minimum setzen**  
  - Jeder bekommt nur das, was er zum Arbeiten braucht  
- **Alle Benutzerkonten müssen eingeschränkt sein**  
  - Apps sollten mit minimalen Rechten laufen  
- **Keine Admin-Rechte für Benutzer**  
  - Begrenzt den Schaden, den Angriffe anrichten können  

```yml
- name: Enforce Least Privilege
  hosts: clients
  tasks:
    - name: Create a limited user group
      group:
        name: limited
        state: present

    - name: Add user to limited group
      user:
        name: lucian
        groups: limited
        append: yes
```
---

## **Konfigurationsdurchsetzung**  
- **Geräte überprüfen**  
  - Jedes Mal, wenn ein Gerät verbunden wird  
- **Umfassende Checks**  
  - OS-Patch-Version  
  - Endpoint Detection and Response (EDR)-Version  
  - Status von Firewall und EDR  
  - Zertifikatstatus  
- **Nicht-konforme Systeme isolieren**  
  - Privates VLAN mit eingeschränktem Zugang  
  - Nach Korrekturen erneut prüfen  

```yml
- name: Configuration Enforcement
  hosts: clients
  tasks:
    - name: Ensure Firewall is running (Debian-based systems)
      service:
        name: ufw
        state: started
        enabled: yes
      when: ansible_os_family == "Debian"

    - name: Ensure Firewall is running (Red Hat-based systems)
      service:
        name: firewalld
        state: started
        enabled: yes
      when: ansible_os_family == "RedHat"

    - name: Verify certificate status
      command: openssl verify /path/to/certificate.pem
```
---

## **Stilllegung (Decommissioning)**  
- **Sollte eine klare Regelung haben**  
  - Schmeiß deine Daten nicht einfach in den Müll  
  - Jemand könnte die später finden  
- **Meist bei Speichermedien relevant**  
  - Festplatten, SSDs, USB-Sticks  
- **Optionen für physische Geräte**  
  - Gerät recyceln und woanders verwenden  
  - Gerät zerstören  

```yml
- name: Secure Data Deletion
  hosts: clients
  tasks:
    - name: Shred storage device securely
      command: shred -n 3 -v /dev/sdb
      when: ansible_os_family in ["RedHat", "Debian"]
```
---

## **System-Hardening**
- **Vielfältige Maßnahmen**  
  - Windows, Linux, iOS, Android und andere Betriebssysteme  
- **Updates**  
  - Betriebssystem-Updates, Service-Packs, Sicherheits-Patches  
- **Benutzerkonten**  
  - Mindestanforderungen an Passwortlänge und -komplexität  
  - Einschränkungen bei Benutzerkonten  
- **Netzwerkzugang und Sicherheit**  
  - Netzwerkzugriff begrenzen  
- **Überwachen und Absichern**  
  - Anti-Virus, Anti-Malware  

- **Updates installieren (für Debian und Red Hat-basierte Systeme):**
```yaml
- name: System Hardening - Updates
  hosts: clients
  tasks:
    - name: System-Updates für Debian-basierte Systeme
      apt:
        update_cache: yes
        upgrade: dist
      when: ansible_os_family == "Debian"

    - name: System-Updates für Red Hat-basierte Systeme
      yum:
        name: "*"
        state: latest
      when: ansible_os_family == "RedHat"
```

- **Benutzerkonten absichern:**
```yaml
- name: Benutzerkonten sichern
  hosts: clients
  tasks:
    - name: Passwortanforderungen festlegen
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^minlen'
        line: 'minlen = 12'
        state: present
      when: ansible_os_family in ["RedHat", "Debian"]

    - name: Einschränkungen für Benutzerkonten hinzufügen
      user:
        name: testuser
        password_lock: yes
        shell: /sbin/nologin
      when: ansible_os_family in ["RedHat", "Debian"]
```

- **Netzwerkzugang begrenzen:**
```yaml
- name: Netzwerkzugang einschränken
  hosts: clients
  tasks:
    - name: SSH-Zugang auf bestimmte IPs beschränken
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^AllowUsers'
        line: 'AllowUsers ansible@192.168.100.0/24'
        state: present
    - name: SSH-Dienst neu starten
      service:
        name: sshd
        state: restarted
```
---

## **Verschlüsselung**
- **Zugriff auf Anwendungsdaten verhindern**  
  - Dateisystemverschlüsselung  
  - Windows Encrypting File System (EFS)  
- **Verschlüsselung der gesamten Festplatte (FDE)**  
  - Verschlüsselung des gesamten Laufwerks  
  - Windows BitLocker, Apple FileVault usw.  
- **Verschlüsselung aller Netzwerkkommunikation**  
  - Virtual Private Network (VPN)  
  - Anwendungsbasierte Verschlüsselung  

- **Dateisystemverschlüsselung aktivieren:**
```yaml
- name: Dateisystemverschlüsselung
  hosts: clients
  tasks:
    - name: Installiere Verschlüsselungs-Tools
      package:
        name: cryptsetup
        state: present

    - name: Festplatte verschlüsseln
      command: cryptsetup luksFormat /dev/sdb --batch-mode
      when: ansible_os_family in ["RedHat", "Debian"]
```

- **Verschlüsselung der gesamten Festplatte (FDE):**
```yaml
- name: Full Disk Encryption (FDE)
  hosts: clients
  tasks:
    - name: BitLocker aktivieren (Windows)
      win_shell: "manage-bde -on C: -password"
      when: ansible_os_family == "Windows"

    - name: FileVault aktivieren (macOS)
      command: fdesetup enable
      when: ansible_os_family == "Darwin"
```

- **Netzwerkverschlüsselung aktivieren (VPN):**
```yaml
- name: VPN einrichten
  hosts: clients
  tasks:
    - name: OpenVPN installieren
      package:
        name: openvpn
        state: present
      when: ansible_os_family in ["RedHat", "Debian"]

    - name: OpenVPN-Dienst aktivieren
      service:
        name: openvpn
        state: started
        enabled: yes
```

## **Verwendung**
Speichere diese Playbooks als `.yml`-Dateien und führe sie mit dem folgenden Befehl aus:

```bash
ansible-playbook -i inventory_file playbook.yml
```

