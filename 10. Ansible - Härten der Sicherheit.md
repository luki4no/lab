# Inhaltsverzeichnis
- [Abschwächung von Sicherheitsangriffen](#abschwächung-von-sicherheitsangriffen)
  - [Patching](#patching)
  - [Verschlüsselung](#verschlüsselung)
  - [Überwachung (Monitoring)](#überwachung-monitoring)
  - [Minimalprinzip (Least Privilege)](#minimalprinzip-least-privilege)
  - [Konfigurationsdurchsetzung](#konfigurationsdurchsetzung)
  - [Stilllegung (Decommissioning)](#stilllegung-decommissioning)
- [System-Hardening](#system-hardening)
  - [Verschlüsselung der gesamten Festplatte (FDE) - centos Beispiel](#verschlüsselung-der-gesamten-festplatte-fde---centos-beispiel)
  - [Netzwerkverschlüsselung aktivieren (VPN)](#netzwerkverschlüsselung-aktivieren-vpn)
  - [SSH -Hardening](#SSH-Hardening)
- [Verwendung](#verwendung)


# Abschwächung von Sicherheitsangriffen

Um einen konsistenten Zustand auf allen Maschinen in dieser Umgebung zu gewährleisten, automatisieren wir den Hardening-Prozess mit Ansible.

## **Patching**  
- **Super wichtig**  
  - Systemstabilität und Sicherheitsfixes  
- **Monatliche Updates**  
  - Inkrementell (und wichtig)  
- **Drittanbieter-Updates**  
  - Anwendungsentwickler, Gerätetreiber  
- **Automatische Updates**  
  - Nicht immer die beste Wahl  
- **Notfall-Updates außerhalb des Plans**  
  - Zero-Day-Lücken und wichtige Sicherheitsprobleme  

```yml
- name: System Updates and Patching
  hosts: clients
  tasks:
    - name: Update and upgrade (Debian-based systems)
      apt:
        update_cache: yes
        upgrade: dist
      when: ansible_os_family == "Debian"

    - name: Update all packages (Red Hat-based systems)
      yum:
        name: "*"
        state: latest
      when: ansible_os_family == "RedHat"
```

---

## **Verschlüsselung**  
- **Zugriff auf Anwendungsdaten blockieren**  
  - Dateisystemverschlüsselung  
- **Verschlüsselung der gesamten Festplatte (FDE)**  
  - Alles auf der Festplatte verschlüsseln  
  - BitLocker, FileVault, LUKS usw.  
- **Dateiebene-Verschlüsselung**  
  - Windows EFS  
- **Anwendungsdatenverschlüsselung**  
  - Von der App verwaltet  
  - Gespeicherte Daten sind geschützt  

```yml
- name: Disk Encryption with LUKS
  hosts: clients
  tasks:
    - name: Install cryptsetup tools
      package:
        name: cryptsetup
        state: present

    - name: Format disk with LUKS encryption
      command: cryptsetup luksFormat /dev/sdb --batch-mode
      when: ansible_os_family in ["RedHat", "Debian"]
```
---

## **Überwachung** (Monitoring) 
- **Infos von Geräten sammeln**  
  - Eingebaute Sensoren, externe Geräte  
  - In Server, Switches, Router, Firewalls usw. integriert  
- **Sensoren**  
  - Intrusion-Prevention-Systeme, Firewall-Logs,  
    Authentifizierungsprotokolle, Webserver-Zugriffslogs,  
    Datenbanktransaktionslogs, E-Mail-Logs  
- **Sammelstellen**  
  - Proprietäre Konsolen (IPS, Firewall)  
  - SIEM-Konsolen, Syslog-Server  
  - Viele SIEM-Systeme haben Engines, die Sensordaten vergleichen  

```yml
- name: Install Elastic Agent for Monitoring
  hosts: clients
  tasks:
    - name: Install Elastic Agent (Debian)
      apt:
        name: elastic-agent
        state: latest
      when: ansible_os_family == "Debian"

    - name: Install Elastic Agent (Red Hat)
      yum:
        name: elastic-agent
        state: latest
      when: ansible_os_family == "RedHat"
```
---

## **Minimalprinzip (Least Privilege)**  
- **Rechte und Berechtigungen aufs Minimum setzen**  
  - Jeder bekommt nur das, was er zum Arbeiten braucht  
- **Alle Benutzerkonten müssen eingeschränkt sein**  
  - Apps sollten mit minimalen Rechten laufen  
- **Keine Admin-Rechte für Benutzer**  
  - Begrenzt den Schaden, den Angriffe anrichten können  

```yml
- name: Enforce Least Privilege
  hosts: clients
  tasks:
    - name: Create a limited user group
      group:
        name: limited
        state: present

    - name: Add user to limited group
      user:
        name: lucian
        groups: limited
        append: yes
```
---

## **Konfigurationsdurchsetzung**  
- **Geräte überprüfen**  
  - Jedes Mal, wenn ein Gerät verbunden wird  
- **Umfassende Checks**  
  - OS-Patch-Version  
  - Endpoint Detection and Response (EDR)-Version  
  - Status von Firewall und EDR  
  - Zertifikatstatus  
- **Nicht-konforme Systeme isolieren**  
  - Privates VLAN mit eingeschränktem Zugang  
  - Nach Korrekturen erneut prüfen  

```yml
- name: Configuration Enforcement
  hosts: clients
  tasks:
    - name: Ensure Firewall is running (Debian-based systems)
      service:
        name: ufw
        state: started
        enabled: yes
      when: ansible_os_family == "Debian"

    - name: Ensure Firewall is running (Red Hat-based systems)
      service:
        name: firewalld
        state: started
        enabled: yes
      when: ansible_os_family == "RedHat"

    - name: Verify certificate status
      command: openssl verify /path/to/certificate.pem
```
---

## **Stilllegung (Decommissioning)**  
- **Sollte eine klare Regelung haben**  
  - Schmeiß deine Daten nicht einfach in den Müll  
  - Jemand könnte die später finden  
- **Meist bei Speichermedien relevant**  
  - Festplatten, SSDs, USB-Sticks  
- **Optionen für physische Geräte**  
  - Gerät recyceln und woanders verwenden  
  - Gerät zerstören  

```yml
- name: Secure Data Deletion
  hosts: clients
  tasks:
    - name: Shred storage device securely
      command: shred -n 3 -v /dev/sdb
      when: ansible_os_family in ["RedHat", "Debian"]
```
---

# **System-Hardening**
- **Vielfältige Maßnahmen**  
  - Windows, Linux, iOS, Android und andere Betriebssysteme  
- **Updates**  
  - Betriebssystem-Updates, Service-Packs, Sicherheits-Patches  
- **Benutzerkonten**  
  - Mindestanforderungen an Passwortlänge und -komplexität  
  - Einschränkungen bei Benutzerkonten  
- **Netzwerkzugang und Sicherheit**  
  - Netzwerkzugriff begrenzen  
- **Überwachen und Absichern**  
  - Anti-Virus, Anti-Malware  

- **Updates installieren (für Debian und Red Hat-basierte Systeme):**
```yaml
- name: System Hardening - Updates
  hosts: clients
  tasks:
    - name: Apply updates for Debian-based systems
      apt:
        update_cache: yes
        upgrade: dist
      when: ansible_os_family == "Debian"

    - name: Apply updates for Red Hat-based systems
      yum:
        name: "*"
        state: latest
      when: ansible_os_family == "RedHat"
```

- **Benutzerkonten absichern:**
```yaml
- name: Secure user accounts
  hosts: clients
  tasks:
    - name: Set password requirements
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^minlen'
        line: 'minlen = 12'
        state: present
      when: ansible_os_family in ["RedHat", "Debian"]

    - name: Add restrictions to user accounts
      user:
        name: testuser
        password_lock: yes
        shell: /sbin/nologin
      when: ansible_os_family in ["RedHat", "Debian"]
```

- **Netzwerkzugang begrenzen:**
```yaml
- name: Restrict network access
  hosts: clients
  tasks:
    - name: Limit SSH access to specific IPs
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^AllowUsers'
        line: 'AllowUsers ansible@192.168.100.0/24'
        state: present
    - name: Restart SSH service
      service:
        name: sshd
        state: restarted
```
---

## **Verschlüsselung**
- **Zugriff auf Anwendungsdaten verhindern**  
  - Dateisystemverschlüsselung  
  - Windows Encrypting File System (EFS)  
- **Verschlüsselung der gesamten Festplatte (FDE)**  
  - Verschlüsselung des gesamten Laufwerks  
  - Windows BitLocker, Apple FileVault, Linux LUKS usw.  
- **Verschlüsselung aller Netzwerkkommunikation**  
  - Virtual Private Network (VPN)  
  - Anwendungsbasierte Verschlüsselung  

- **Dateisystemverschlüsselung aktivieren:**
```yaml
- name: Enable file system encryption
  hosts: clients
  tasks:
    - name: Install encryption tools
      package:
        name: cryptsetup
        state: present

    - name: Encrypt disk
      command: cryptsetup luksFormat /dev/sdb --batch-mode
      when: ansible_os_family in ["RedHat", "Debian"]
```

- **Verschlüsselung der gesamten Festplatte (FDE) - centos Beispiel:**
```yaml
- name: Convert CentOS to LUKS-encrypted setup
  hosts: centos
  become: true
  tasks:
    # Backup Notice
    - name: Backup notice
      debug:
        msg: "Ensure you have a full backup before proceeding. This playbook will format and encrypt root and swap volumes."

    # Install required tools
    - name: Install cryptsetup for LUKS
      yum:
        name: cryptsetup
        state: present

    # Unmount filesystems
    - name: Unmount root filesystem
      command: umount /dev/mapper/VolGroup-root
      ignore_errors: yes

    - name: Unmount swap partition
      command: swapoff /dev/mapper/VolGroup-swap
      ignore_errors: yes

    # Close LVM volumes
    - name: Deactivate LVM volume group
      command: vgchange -an VolGroup

    # Encrypt logical volumes with LUKS
    - name: Encrypt root volume with LUKS
      command: cryptsetup luksFormat /dev/VolGroup/root --batch-mode --cipher aes-xts-plain64 --key-size 512 --hash sha256

    - name: Encrypt swap volume with LUKS
      command: cryptsetup luksFormat /dev/VolGroup/swap --batch-mode --cipher aes-xts-plain64 --key-size 512 --hash sha256

    # Open encrypted volumes
    - name: Open encrypted root volume
      command: cryptsetup luksOpen /dev/VolGroup/root luks-root

    - name: Open encrypted swap volume
      command: cryptsetup luksOpen /dev/VolGroup/swap luks-swap

    # Format encrypted volumes
    - name: Format encrypted root volume with xfs
      filesystem:
        fstype: xfs
        dev: /dev/mapper/luks-root

    - name: Format encrypted swap volume
      command: mkswap /dev/mapper/luks-swap

    # Update fstab and crypttab for encrypted volumes
    - name: Add encrypted root volume to crypttab
      lineinfile:
        path: /etc/crypttab
        line: "luks-root /dev/VolGroup/root none luks"
        state: present

    - name: Add encrypted swap volume to crypttab
      lineinfile:
        path: /etc/crypttab
        line: "luks-swap /dev/VolGroup/swap none luks"
        state: present

    - name: Update fstab for encrypted root volume
      lineinfile:
        path: /etc/fstab
        line: "/dev/mapper/luks-root / xfs defaults 0 1"
        state: present

    - name: Update fstab for encrypted swap volume
      lineinfile:
        path: /etc/fstab
        line: "/dev/mapper/luks-swap swap swap defaults 0 0"
        state: present

    # Reactivate and mount encrypted volumes
    - name: Mount encrypted root volume
      mount:
        path: /
        src: /dev/mapper/luks-root
        fstype: xfs
        state: mounted

    - name: Enable encrypted swap volume
      command: swapon /dev/mapper/luks-swap

    # Rebuild initramfs to include LUKS configuration
    - name: Rebuild initramfs
      command: dracut -f

    # Update GRUB to include LUKS configuration
    - name: Update GRUB configuration
      command: grub2-mkconfig -o /boot/grub2/grub.cfg
```

- **Netzwerkverschlüsselung aktivieren (VPN):**
```yaml
- name: Setup VPN
  hosts: clients
  tasks:
    - name: Install OpenVPN
      package:
        name: openvpn
        state: present
      when: ansible_os_family in ["RedHat", "Debian"]

    - name: Start and enable OpenVPN service
      service:
        name: openvpn
        state: started
        enabled: yes
```

# SSH-Hardening

Dieses Playbook funktioniert sowohl auf **Debian-** als auch auf **Red Hat-basierten Systemen**, da die Konfiguration von SSH in der Datei `/etc/ssh/sshd_config` in beiden Distributionen identisch ist. 

```yaml
---
- name: Harden SSH settings
  hosts: clients
  become: yes
  tasks:
    - name: Disable root login and enable key-based authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin no'
      notify:
        - Restart SSH

    - name: Ensure PubkeyAuthentication is enabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#PubkeyAuthentication yes'
        line: 'PubkeyAuthentication yes'
      notify:
        - Restart SSH

    - name: Disable password authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#PasswordAuthentication yes'
        line: 'PasswordAuthentication no'
      notify:
        - Restart SSH

    - name: Set SSH protocol to version 2
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#Protocol'
        line: 'Protocol 2'
      notify:
        - Restart SSH

    - name: Disable empty passwords
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#PermitEmptyPasswords'
        line: 'PermitEmptyPasswords no'
      notify:
        - Restart SSH

    - name: Limit SSH access to specific users
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#AllowUsers'
        line: 'AllowUsers your_username'  # Ersetzen Sie 'your_username' durch den gewünschten Benutzernamen
      notify:
        - Restart SSH

  handlers:
    - name: Restart SSH
      service:
        name: sshd
        state: restarted
```

# **Verwendung**
Speichere diese Playbooks als `.yml`-Dateien und führe sie mit dem folgenden Befehl aus:

```bash
ansible-playbook -i inventory_file playbook.yml --ask-become-pass
```

