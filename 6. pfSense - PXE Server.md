# Voraussetzungen

Du kannst einen PXE (Preboot Execution Environment) Server auf pfSense einrichten, obwohl es keine integrierte Funktion dafür gibt. Um dies zu erreichen, musst du in der Regel zusätzliche Tools oder Pakete verwenden, um den PXE-Bootprozess zu ermöglichen. Hier ist eine allgemeine Anleitung, wie du das einrichten kannst:

### Schritte zum Einrichten von PXE auf pfSense

1. **DHCP-Server auf pfSense aktivieren** (haben wir schon):
   - Gehe zu **Services > DHCP Server**.
   - Aktiviere den DHCP-Server für die Schnittstelle, die du verwenden möchtest (normalerweise die LAN-Schnittstelle).
   - Konfiguriere die DHCP-Einstellungen, einschließlich des IP-Adressbereichs und anderer Optionen.

```plaintext
webConfigurator http://192.168.100.2/
Services > DHCP Server > LAN
```
- [x] Enable DHCP server on LAN interface
- Address Pool Range: 192.168.100.100 - 192.168.100.200
---
2. **DHCP-Optionen für PXE konfigurieren** (brauchen wir):
   - Finde im DHCP-Serverbereich den Abschnitt **DHCP Static Mappings**, um die statischen IPs für deine PXE-Clients zu definieren, falls nötig.
   - Setze die DHCP-Optionen für PXE:
     - **Option 66**: Dies sollte auf die IP-Adresse deines TFTP-Servers (wo die PXE-Bootdateien bereitgestellt werden) zeigen.
     - **Option 67**: Dies gibt den Boot-Dateinamen an, typischerweise etwas wie `pxelinux.0`.

```plaintext
webConfigurator http://192.168.100.2/
Services > DHCP Server > LAN
```
- Other DHCP Options
   - **Option 66 (TFTP Server Name)**
        - Custom DHCP Options: Display Advanced 
           - Custom Option Number: `66`
           - Custom Option Type: `IP address or host`
           - Custom Option Value: `192.168.100.2`
   - **Option 67 (Bootfile Name)**
        - Custom DHCP Options: Display Advanced 
           - Custom Option Number: `67`
           - Custom Option Type: `String`
           - Custom Option Value: `"pxelinux.0"`
---
3. **TFTP-Server installieren** (brauchen wir)
   - Stelle sicher, dass der TFTP-Server so konfiguriert ist, dass die notwendigen PXE-Bootdateien bereitgestellt werden, wie z. B. `pxelinux.0`, Kernel-Images und Initrd-Dateien.
   - pfSense hat die TFTP Funktion nich integriert, doch diese kann nachgerüstet werden. Folgendes ausführen:

Installieren:
```plaintext
webConfigurator http://192.168.100.2/
System > Package Manager > Available Packages
```

1. Search term: tftpd
2. +Install
3. Confirm

Aktivieren:
```plaintext
webConfigurator http://192.168.100.2/
Services > TFTP Server
```
- Settings
   - General Options
      - Enable TFTP service:
         - [x] Check to enable the TFTP service.
      - IPv4 Only:
         - [x] Check to allow clients to connect with IPv4 only.
      - Save
- Files
   - Upload
---
4. **PXE-Bootdateien vorbereiten** (brauchen wir):
   - Lege die notwendigen PXE-Bootdateien im TFTP-Stammverzeichnis deines TFTP-Servers ab. Dazu gehören typischerweise:
     - `pxelinux.0` (von syslinux)
     - Eine Konfigurationsdatei für den PXE-Boot (z. B. `pxelinux.cfg/default`)
     - Kernel-Images und Initrd-Dateien für die Betriebssysteme, die du bereitstellen möchtest.

Die PXE-relevanten Dateien werden in pfSense unter /tftpboot landen:

Wir listen den Inhalt des TFTP Root-Ordners:
```powershell
ssh admin@192.168.100.2 ls -l /tftpboot
```

Wir erstellen folgende Ordnerstruktur. Jede Distribution erhält ihre eigenen PXE-Bootdateien.

Betriebssystem-Ordner zuerst:

```powershell
ssh admin@192.168.100.2 mkdir -p /tftpboot/centos
```
```powershell
ssh admin@192.168.100.2 mkdir -p /tftpboot/fedora
```
```powershell
ssh admin@192.168.100.2 mkdir -p /tftpboot/ubuntu
```
```powershell
ssh admin@192.168.100.2 mkdir -p /tftpboot/debian
```
```powershell
ssh admin@192.168.100.2 mkdir -p /tftpboot/kali
```

Danach den PXE-Konfig-Ordner:

```powershell
ssh admin@192.168.100.2 mkdir -p /tftpboot/pxelinux.cfg
```
```powershell
ssh admin@192.168.100.2 touch /tftpboot/pxelinux.cfg/default
```
> `/tftpboot/pxelinux.cfg/default` ist unsere Hauptkonfigurationsdatei, in der wir alle anderen Betriebssysteme referenzieren werden. Jedes OS bekommt seine eigene Stanza mit den Adressen zu den jeweiligen Kernel-Images und Initial-RAM-Disk-Images.

In der pfsense Shell wird die Struktur so aussehen:
```bash
[2.7.2-RELEASE][admin@pfSense.home.arpa]/root: cd /tftpboot
[2.7.2-RELEASE][admin@pfSense.home.arpa]/tftpboot: ls -lR
total 3
drwxr-xr-x  2 root nobody 5 Oct 29 16:28 centos
drwxr-xr-x  2 root nobody 2 Oct 29 16:27 debian
drwxr-xr-x  2 root nobody 2 Oct 29 16:26 fedora
drwxr-xr-x  2 root nobody 2 Oct 29 16:27 kali
drwxr-xr-x  2 root nobody 3 Oct 29 15:38 pxelinux.cfg
drwxr-xr-x  2 root nobody 2 Oct 29 16:27 ubuntu

./centos:
total 159322
-r--r--r--  1 root nobody 148747676 Oct 29 15:22 initrd.img
-rw-r--r--  1 root nobody      2094 Oct 29 15:44 ks-centos.cfg
-r--r--r--  1 root nobody  14428200 Oct 29 15:22 vmlinuz

./debian:
total 0

./fedora:
total 0

./kali:
total 0

./pxelinux.cfg:
total 5
-rw-r--r--  1 root nobody 202 Oct 29 16:50 default

./ubuntu:
total 0
[2.7.2-RELEASE][admin@pfSense.home.arpa]/tftpboot:
```

# Wie machen weiter mit CentOS

Wir transferieren die PXE-Bootdateien für CentOS.

Die CentOS DVD-ISO in Windows mounten: `CentOS-Stream-9-latest-x86_64-dvd1.iso`

Danach via scp in PowerShell transferieren:

```powershell
scp "D:\isolinux\vmlinuz" admin@192.168.100.2:/tftpboot/centos
```
```powershell
scp "D:\isolinux\initrd.img" admin@192.168.100.2:/tftpboot/centos
```
```powershell
scp "D:\isolinux\isolinux.bin" admin@192.168.100.2:/tftpboot/centos
```

Wir fügen die vorbereitete CentOS Kickstart-Datei hinzu um die Installation zu automatisieren:
```bash
scp "C:\lab\vm\automation\ks-centos.cfg" admin@192.168.100.2:/tftpboot/centos
```

Wir erstellen und bearbeiten die PXE-Konfigurationsdateien. Struktur wird so aussehen:

```powerhsell
PS > ssh admin@192.168.100.2

[2.7.2-RELEASE][admin@pfSense.home.arpa]/tftpboot: cd /tftpboot
[2.7.2-RELEASE][admin@pfSense.home.arpa]/tftpboot: ls -lR
total 3
drwxr-xr-x  2 root nobody 5 Oct 29 16:28 centos
drwxr-xr-x  2 root nobody 2 Oct 29 16:27 debian
drwxr-xr-x  2 root nobody 2 Oct 29 16:26 fedora
drwxr-xr-x  2 root nobody 2 Oct 29 16:27 kali
drwxr-xr-x  2 root nobody 3 Oct 29 15:38 pxelinux.cfg
drwxr-xr-x  2 root nobody 2 Oct 29 16:27 ubuntu

./centos:
total 159322
-r--r--r--  1 root nobody 148747676 Oct 29 15:22 initrd.img
-rw-r--r--  1 root nobody      2094 Oct 29 15:44 ks-centos.cfg
-r--r--r--  1 root nobody  14428200 Oct 29 15:22 vmlinuz

./debian:
total 0

./fedora:
total 0

./kali:
total 0

./pxelinux.cfg:
total 5
-rw-r--r--  1 root nobody 136 Oct 29 15:59 default

./ubuntu:
total 0
[2.7.2-RELEASE][admin@pfSense.home.arpa]/tftpboot:
```

---
5. **PXE-Boot testen** (brauchen wir):
   - Starte einen Client-Computer, der PXE unterstützt.
   - Stelle sicher, dass er so konfiguriert ist, dass er zuerst vom Netzwerk bootet.
   - Der Client sollte eine IP-Adresse vom pfSense-DHCP-Server erhalten und sich mit dem TFTP-Server verbinden, um die Bootdateien herunterzuladen.
---
### Zusätzliche Überlegungen:
- **Firewall-Regeln**: Stelle sicher, dass die Firewall-Regeln von pfSense DHCP- und TFTP-Verkehr erlauben. Möglicherweise musst du Regeln erstellen, um den UDP-Verkehr auf den Ports 67 (DHCP) und 69 (TFTP) zuzulassen.
- **Leistung**: Für Produktionsumgebungen solltest du in Betracht ziehen, einen dedizierten TFTP-Server für eine bessere Leistung und Verwaltung zu verwenden.
- **Dokumentation**: Konsultiere die pfSense-Dokumentation für spezifische Konfigurationsdetails oder Fehlersuche.

Wenn du diese Schritte befolgst, solltest du in der Lage sein, einen PXE-Server mithilfe von pfSense in deiner Netzwerkumgebung einzurichten.

