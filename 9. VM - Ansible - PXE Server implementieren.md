# PXE Playbook erstellen

```bash
sudo touch ansible-pxe-setup.yml
```
```bash
sudo nano ansible-pxe-setup.yml
```
```yml
---
- hosts: localhost
  become: true
  tasks:
    - name: Install necessary packages
      yum:
        name:
          - dhcp-server
          - tftp-server
          - syslinux
          - nfs-utils
          - grub2-efi-x64  # EFI bootloader package
        state: present

    - name: Create NFS directories for each distribution
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /var/nfs/iso
        - /var/nfs/iso/centos
        - /var/nfs/iso/fedora
        - /var/nfs/iso/ubuntu
        - /var/nfs/iso/debian
        - /var/nfs/iso/kali
      notify: Restart nfs

    - name: Create TFTP boot directories for BIOS and EFI
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /var/lib/tftpboot/pxelinux.cfg  # For BIOS
        - /var/lib/tftpboot/efi/boot      # For EFI

    - name: Copy PXE boot files for BIOS
      copy:
        src: /usr/share/syslinux/pxelinux.0
        dest: /var/lib/tftpboot/pxelinux.0

    - name: Copy EFI boot files
      copy:
        src: /boot/efi/EFI/centos/grubx64.efi
        dest: /var/lib/tftpboot/efi/boot/grubx64.efi
        remote_src: yes

    - name: Create pxelinux.cfg default configuration file for BIOS
      copy:
        dest: /var/lib/tftpboot/pxelinux.cfg/default
        content: |
          DEFAULT menu
          PROMPT 0
          MENU TITLE PXE Boot Menu
          TIMEOUT 600

          LABEL CentOS
            KERNEL /var/nfs/iso/centos/vmlinuz
            APPEND initrd=/var/nfs/iso/centos/initrd.img

          LABEL Fedora
            KERNEL /var/nfs/iso/fedora/vmlinuz
            APPEND initrd=/var/nfs/iso/fedora/initrd.img

          LABEL Ubuntu
            KERNEL /var/nfs/iso/ubuntu/vmlinuz
            APPEND initrd=/var/nfs/iso/ubuntu/initrd.img

          LABEL Debian
            KERNEL /var/nfs/iso/debian/vmlinuz
            APPEND initrd=/var/nfs/iso/debian/initrd.img

          LABEL Kali
            KERNEL /var/nfs/iso/kali/vmlinuz
            APPEND initrd=/var/nfs/iso/kali/initrd.img

    - name: Create grub.cfg configuration file for EFI
      copy:
        dest: /var/lib/tftpboot/efi/boot/grub.cfg
        content: |
          set timeout=10
          menuentry 'Install CentOS' {
            linuxefi /var/nfs/iso/centos/vmlinuz
            initrdefi /var/nfs/iso/centos/initrd.img
          }
          menuentry 'Install Fedora' {
            linuxefi /var/nfs/iso/fedora/vmlinuz
            initrdefi /var/nfs/iso/fedora/initrd.img
          }
          menuentry 'Install Ubuntu' {
            linuxefi /var/nfs/iso/ubuntu/vmlinuz
            initrdefi /var/nfs/iso/ubuntu/initrd.img
          }
          menuentry 'Install Debian' {
            linuxefi /var/nfs/iso/debian/vmlinuz
            initrdefi /var/nfs/iso/debian/initrd.img
          }
          menuentry 'Install Kali' {
            linuxefi /var/nfs/iso/kali/vmlinuz
            initrdefi /var/nfs/iso/kali/initrd.img
          }

    - name: Mount and extract files from CentOS ISO
      block:
        - name: Create mount point for CentOS
          file:
            path: /mnt/centos
            state: directory

        - name: Mount CentOS ISO
          command: mount -o loop /home/lucian/iso/CentOS-Stream-9-latest-x86_64-dvd1.iso /mnt/centos

        - name: Copy initrd.img for CentOS
          copy:
            src: /mnt/centos/isolinux/initrd.img
            dest: /var/nfs/iso/centos/initrd.img
            remote_src: yes

        - name: Copy vmlinuz for CentOS
          copy:
            src: /mnt/centos/isolinux/vmlinuz
            dest: /var/nfs/iso/centos/vmlinuz
            remote_src: yes

        - name: Unmount CentOS ISO
          command: umount /mnt/centos

    - name: Mount and extract files from Fedora ISO
      block:
        - name: Create mount point for Fedora
          file:
            path: /mnt/fedora
            state: directory

        - name: Mount Fedora ISO
          command: mount -o loop /home/lucian/iso/Fedora-Everything-netinst-x86_64-40-1.14.iso /mnt/fedora

        - name: Copy initrd.img for Fedora
          copy:
            src: /mnt/fedora/images/pxeboot/initrd.img
            dest: /var/nfs/iso/fedora/initrd.img
            remote_src: yes

        - name: Copy vmlinuz for Fedora
          copy:
            src: /mnt/fedora/images/pxeboot/vmlinuz
            dest: /var/nfs/iso/fedora/vmlinuz
            remote_src: yes

        - name: Unmount Fedora ISO
          command: umount /mnt/fedora

    - name: Mount and extract files from Ubuntu ISO
      block:
        - name: Create mount point for Ubuntu
          file:
            path: /mnt/ubuntu
            state: directory

        - name: Mount Ubuntu ISO
          command: mount -o loop /home/lucian/iso/ubuntu-24.04.1-live-server-amd64.iso /mnt/ubuntu

        - name: Copy initrd.img for Ubuntu
          copy:
            src: /mnt/ubuntu/casper/initrd
            dest: /var/nfs/iso/ubuntu/initrd.img
            remote_src: yes

        - name: Copy vmlinuz for Ubuntu
          copy:
            src: /mnt/ubuntu/casper/vmlinuz
            dest: /var/nfs/iso/ubuntu/vmlinuz
            remote_src: yes

        - name: Unmount Ubuntu ISO
          command: umount /mnt/ubuntu

    - name: Mount and extract files from Debian ISO
      block:
        - name: Create mount point for Debian
          file:
            path: /mnt/debian
            state: directory

        - name: Mount Debian ISO
          command: mount -o loop /home/lucian/iso/debian-12.7.0-amd64-netinst.iso /mnt/debian

        - name: Copy initrd.img for Debian
          copy:
            src: /mnt/debian/install.amd/initrd.gz
            dest: /var/nfs/iso/debian/initrd.img
            remote_src: yes

        - name: Copy vmlinuz for Debian
          copy:
            src: /mnt/debian/install.amd/vmlinuz
            dest: /var/nfs/iso/debian/vmlinuz
            remote_src: yes

        - name: Unmount Debian ISO
          command: umount /mnt/debian

    - name: Mount and extract files from Kali ISO
      block:
        - name: Create mount point for Kali
          file:
            path: /mnt/kali
            state: directory

        - name: Mount Kali ISO
          command: mount -o loop /home/lucian/iso/kali-linux-2024.3-installer-netinst-amd64.iso /mnt/kali

        - name: Copy initrd.img for Kali
          copy:
            src: /mnt/kali/install.amd/initrd.gz
            dest: /var/nfs/iso/kali/initrd.img
            remote_src: yes

        - name: Copy vmlinuz for Kali
          copy:
            src: /mnt/kali/install.amd/vmlinuz
            dest: /var/nfs/iso/kali/vmlinuz
            remote_src: yes

        - name: Unmount Kali ISO
          command: umount /mnt/kali

    - name: Configure DHCP server
      copy:
        dest: /etc/dhcp/dhcpd.conf
        content: |
          option domain-name "localdomain";
          option domain-name-servers 8.8.8.8, 8.8.4.4;
          default-lease-time 600;
          max-lease-time 7200;
          subnet 192.168.100.0 netmask 255.255.255.0 {
            range 192.168.100.100 192.168.100.200;
            option routers 192.168.100.2;

            # Check for UEFI 64-bit clients
            if substring(option vendor-class-identifier, 0, 10) = "PXEClient:0" {
              filename "grubx64.efi";
            }

            # Check for UEFI 32-bit clients
            elsif substring(option vendor-class-identifier, 0, 10) = "PXEClient:6" {
              filename "bootia32.efi";
            }

            # Default for BIOS clients
            else {
              filename "pxelinux.0";
            }
          }
      notify: Restart dhcpd

    - name: Configure DHCP interface
      copy:
        dest: /etc/sysconfig/dhcpd
        content: |
          DHCPD_INTERFACE="eth0"  # Replace 'eth0' with the correct interface name
      notify: Restart dhcpd

    - name: Verify DHCP configuration syntax
      command: dhcpd -t -cf /etc/dhcp/dhcpd.conf
      register: dhcpd_config_check
      ignore_errors: true

    - name: Fail if DHCP configuration is invalid
      fail:
        msg: "DHCP configuration file is invalid. Check /etc/dhcp/dhcpd.conf for errors."
      when: dhcpd_config_check.rc != 0

    - name: Enable and start DHCP and TFTP services
      service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - dhcpd
        - tftp
      notify: Reload firewalld

    - name: Enable and start NFS service
      service:
        name: nfs-server
        state: started
        enabled: true
      notify: Reload firewalld

    - name: Configure firewall
      firewalld:
        service: "{{ item }}"
        permanent: true
        state: enabled
      loop:
        - dhcp
        - tftp
        - nfs
      notify: Reload firewalld

  handlers:
    - name: Restart dhcpd
      service:
        name: dhcpd
        state: restarted

    - name: Restart nfs
      service:
        name: nfs-server
        state: restarted

    - name: Reload firewalld
      service:
        name: firewalld
        state: reloaded
```
`Ctrl+O zum speichern`
`Ctrl+X um zu schliessen`

# PXE Playbook ausf√ºhren
```bash
ansible-playbook ansible-pxe-setup.yml --connection=local
```

```bash
[lucian@centos playbooks]$ ansible-playbook ansible-pxe-setup.yml --connection=local

PLAY [localhost] ******************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************
ok: [localhost]

TASK [Install necessary packages] *************************************************************************************************************************
changed: [localhost]

TASK [Create NFS directories for each distribution] *******************************************************************************************************
changed: [localhost] => (item=/var/nfs/iso)
changed: [localhost] => (item=/var/nfs/iso/centos)
changed: [localhost] => (item=/var/nfs/iso/fedora)
changed: [localhost] => (item=/var/nfs/iso/ubuntu)
changed: [localhost] => (item=/var/nfs/iso/debian)
changed: [localhost] => (item=/var/nfs/iso/kali)

TASK [Create TFTP boot directories for BIOS and EFI] ******************************************************************************************************
changed: [localhost] => (item=/var/lib/tftpboot/pxelinux.cfg)
changed: [localhost] => (item=/var/lib/tftpboot/efi/boot)

TASK [Copy PXE boot files for BIOS] ***********************************************************************************************************************
changed: [localhost]

TASK [Copy EFI boot files] ********************************************************************************************************************************
changed: [localhost]

TASK [Create pxelinux.cfg default configuration file for BIOS] ********************************************************************************************
changed: [localhost]

TASK [Create grub.cfg configuration file for EFI] *********************************************************************************************************
changed: [localhost]

TASK [Create mount point for CentOS] **********************************************************************************************************************
changed: [localhost]

TASK [Mount CentOS ISO] ***********************************************************************************************************************************
changed: [localhost]

TASK [Copy initrd.img for CentOS] *************************************************************************************************************************
changed: [localhost]

TASK [Copy vmlinuz for CentOS] ****************************************************************************************************************************
changed: [localhost]

TASK [Unmount CentOS ISO] *********************************************************************************************************************************
changed: [localhost]

TASK [Create mount point for Fedora] **********************************************************************************************************************
changed: [localhost]

TASK [Mount Fedora ISO] ***********************************************************************************************************************************
changed: [localhost]

TASK [Copy initrd.img for Fedora] *************************************************************************************************************************
changed: [localhost]

TASK [Copy vmlinuz for Fedora] ****************************************************************************************************************************
changed: [localhost]

TASK [Unmount Fedora ISO] *********************************************************************************************************************************
changed: [localhost]

TASK [Create mount point for Ubuntu] **********************************************************************************************************************
changed: [localhost]

TASK [Mount Ubuntu ISO] ***********************************************************************************************************************************
changed: [localhost]

TASK [Copy initrd.img for Ubuntu] *************************************************************************************************************************
changed: [localhost]

TASK [Copy vmlinuz for Ubuntu] ****************************************************************************************************************************
changed: [localhost]

TASK [Unmount Ubuntu ISO] *********************************************************************************************************************************
changed: [localhost]

TASK [Create mount point for Debian] **********************************************************************************************************************
changed: [localhost]

TASK [Mount Debian ISO] ***********************************************************************************************************************************
changed: [localhost]

TASK [Copy initrd.img for Debian] *************************************************************************************************************************
changed: [localhost]

TASK [Copy vmlinuz for Debian] ****************************************************************************************************************************
changed: [localhost]

TASK [Unmount Debian ISO] *********************************************************************************************************************************
changed: [localhost]

TASK [Create mount point for Kali] ************************************************************************************************************************
changed: [localhost]

TASK [Mount Kali ISO] *************************************************************************************************************************************
changed: [localhost]

TASK [Copy initrd.img for Kali] ***************************************************************************************************************************
changed: [localhost]

TASK [Copy vmlinuz for Kali] ******************************************************************************************************************************
changed: [localhost]

TASK [Unmount Kali ISO] ***********************************************************************************************************************************
changed: [localhost]

TASK [Configure DHCP server] ******************************************************************************************************************************
changed: [localhost]

TASK [Configure DHCP interface] ***************************************************************************************************************************
changed: [localhost]

TASK [Verify DHCP configuration syntax] *******************************************************************************************************************
changed: [localhost]

TASK [Fail if DHCP configuration is invalid] **************************************************************************************************************
skipping: [localhost]

TASK [Enable and start DHCP and TFTP services] ************************************************************************************************************
changed: [localhost] => (item=dhcpd)
changed: [localhost] => (item=tftp)

TASK [Enable and start NFS service] ***********************************************************************************************************************
changed: [localhost]

TASK [Configure firewall] *********************************************************************************************************************************
changed: [localhost] => (item=dhcp)
changed: [localhost] => (item=tftp)
changed: [localhost] => (item=nfs)

RUNNING HANDLER [Restart dhcpd] ***************************************************************************************************************************
changed: [localhost]

RUNNING HANDLER [Restart nfs] *****************************************************************************************************************************
changed: [localhost]

RUNNING HANDLER [Reload firewalld] ************************************************************************************************************************
changed: [localhost]

PLAY RECAP ************************************************************************************************************************************************
localhost                  : ok=42   changed=41   unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

[lucian@centos playbooks]$
```

# Zusammenfassung

Es sieht so aus, als ob das Playbook erfolgreich ausgef√ºhrt wurde! Hier eine Zusammenfassung der Ausgabe:

- **Alle Aufgaben abgeschlossen**: Jede Aufgabe, einschlie√ülich der Installation der Pakete, der Konfiguration von DHCP, TFTP und NFS sowie der Einrichtung der Firewall, wurde ohne Fehler ausgef√ºhrt.
- **Handler ausgef√ºhrt**: Die notwendigen Handler zum Neustarten von `dhcpd`, `nfs` und zum Neuladen von `firewalld` wurden ausgel√∂st und erfolgreich abgeschlossen.
- **Keine Fehler**: Das Playbook zeigt `failed=0` an, was bedeutet, dass keine Probleme aufgetreten sind.
- **Ge√§nderte Ressourcen**: Die meisten Aufgaben zeigen `changed` an, was bedeutet, dass die erforderlichen Konfigurationen und Anpassungen angewendet wurden.

### N√§chste Schritte
1. **Dienste √ºberpr√ºfen**:
   - √úberpr√ºfe den Status der Dienste, um sicherzustellen, dass sie ordnungsgem√§√ü laufen:
     ```bash
     sudo systemctl status dhcpd
     sudo systemctl status tftp
     sudo systemctl status nfs-server
     sudo systemctl status firewalld
     ```

2. **PXE-Boot testen**:
   - Starte einen BIOS-basierten und einen EFI-basierten Client, um sicherzustellen, dass sie eine IP-Adresse erhalten, die PXE-Boot-Dateien √ºber TFTP laden und auf die Installationsmedien √ºber NFS zugreifen k√∂nnen.

### Fazit
Dein PXE-Server sollte jetzt bereit sein, sowohl BIOS- als auch EFI-Clients zu bedienen! Lass mich wissen, wenn du Hilfe beim Testen der Einrichtung ben√∂tigst oder wenn es zus√§tzliche Konfigurationen gibt, die du vornehmen m√∂chtest.

# Best√§tigen

Um sicherzustellen, dass alle Dienste ordnungsgem√§√ü laufen und die Firewall korrekt konfiguriert ist, kannst du die folgenden Schritte auf deinem CentOS-System ausf√ºhren:

### 1. **Status der Dienste √ºberpr√ºfen**

Verwende `systemctl`, um den Status jedes Dienstes zu pr√ºfen:

```bash
# Status des DHCP-Servers √ºberpr√ºfen
sudo systemctl status dhcpd

# Status des TFTP-Servers √ºberpr√ºfen
sudo systemctl status tftp

# Status des NFS-Servers √ºberpr√ºfen
sudo systemctl status nfs-server

# Status der Firewall √ºberpr√ºfen
sudo systemctl status firewalld
```

- **Erwartete Ausgabe**: Jeder Dienst sollte als `active (running)` angezeigt werden. Falls ein Dienst nicht l√§uft, musst du m√∂glicherweise den Grund ermitteln und das Problem beheben.

### 2. **NFS-Export-Konfiguration √ºberpr√ºfen**

Pr√ºfe die NFS-Exporteinstellungen, um sicherzustellen, dass sie korrekt konfiguriert sind:

```bash
# NFS-Exporte anzeigen
sudo exportfs -v
```

- **Erwartete Ausgabe**: Du solltest die NFS-Exportpfade (z.B. `/var/nfs/iso`) und das erlaubte Netzwerksegment (`192.168.100.0/24`) mit den richtigen Optionen sehen, wie `ro` (nur lesbar), `sync` und `no_root_squash`.

### 3. **Firewall-Konfiguration √ºberpr√ºfen**

Verwende `firewall-cmd`, um zu pr√ºfen, ob die notwendigen Dienste und Ports durch die Firewall erlaubt sind:

```bash
# Alle aktiven Zonen und deren Einstellungen auflisten
sudo firewall-cmd --list-all
```

- **Achte auf**:
  - Im Abschnitt `services` sollten `dhcp`, `tftp` und `nfs` aufgelistet sein.
  - Die entsprechenden Ports sollten offen sein, falls sie manuell konfiguriert wurden.

### 4. **Offene Ports f√ºr bestimmte Dienste √ºberpr√ºfen**

Du kannst pr√ºfen, ob die Ports f√ºr DHCP, TFTP und NFS offen und aktiv sind:

```bash
# Offene und aktive Ports √ºberpr√ºfen
sudo ss -tuln
```

- **Ports, auf die du achten solltest**:
  - **DHCP**: Port `67` (UDP)
  - **TFTP**: Port `69` (UDP)
  - **NFS**: Ports wie `2049` (TCP/UDP), `111` (TCP/UDP f√ºr Portmapper) und andere je nach deiner NFS-Konfiguration.

### 5. **Die Einrichtung testen**

- **DHCP**: Versuche, einen Client vom Netzwerk zu booten, um zu sehen, ob er eine IP-Adresse vom DHCP-Server erh√§lt.
- **TFTP**: Verwende einen TFTP-Client auf einem anderen Rechner, um eine Datei aus dem Verzeichnis `/var/lib/tftpboot` herunterzuladen.
  ```bash
  # Beispielbefehl zum Testen von TFTP (auf einem Client-Rechner)
  tftp 192.168.100.10
  tftp> get pxelinux.0
  ```
- **NFS**: Versuche, das NFS-Share von einem Client innerhalb des Netzwerks `192.168.100.0/24` zu mounten.
  ```bash
  # Beispielbefehl zum Testen von NFS (auf einem Client-Rechner)
  sudo mount -t nfs 192.168.100.10:/var/nfs/iso /mnt
  ```

# Richtige Ausgabe

```bash
[lucian@centos playbooks]$ sudo systemctl status dhcpd
‚óè dhcpd.service - DHCPv4 Server Daemon
     Loaded: loaded (/usr/lib/systemd/system/dhcpd.service; enabled; preset: disabled)
     Active: active (running) since Sat 2024-11-02 18:01:51 CET; 2min 49s ago
       Docs: man:dhcpd(8)
             man:dhcpd.conf(5)
   Main PID: 2661 (dhcpd)
     Status: "Dispatching packets..."
      Tasks: 1 (limit: 48902)
     Memory: 4.6M
        CPU: 8ms
     CGroup: /system.slice/dhcpd.service
             ‚îî‚îÄ2661 /usr/sbin/dhcpd -f -cf /etc/dhcp/dhcpd.conf -user dhcpd -group dhcpd --no-pid

Nov 02 18:01:51 centos dhcpd[2661]: Config file: /etc/dhcp/dhcpd.conf
Nov 02 18:01:51 centos dhcpd[2661]: Database file: /var/lib/dhcpd/dhcpd.leases
Nov 02 18:01:51 centos dhcpd[2661]: PID file: /var/run/dhcpd.pid
Nov 02 18:01:51 centos dhcpd[2661]: Source compiled to use binary-leases
Nov 02 18:01:51 centos dhcpd[2661]: Wrote 0 leases to leases file.
Nov 02 18:01:51 centos dhcpd[2661]: Listening on LPF/eth0/00:15:5d:38:01:16/192.168.100.0/24
Nov 02 18:01:51 centos dhcpd[2661]: Sending on   LPF/eth0/00:15:5d:38:01:16/192.168.100.0/24
Nov 02 18:01:51 centos dhcpd[2661]: Sending on   Socket/fallback/fallback-net
Nov 02 18:01:51 centos dhcpd[2661]: Server starting service.
Nov 02 18:01:51 centos systemd[1]: Started DHCPv4 Server Daemon.
[lucian@centos playbooks]$
[lucian@centos playbooks]$ sudo systemctl status tftp
‚óè tftp.service - Tftp Server
     Loaded: loaded (/usr/lib/systemd/system/tftp.service; indirect; preset: disabled)
     Active: active (running) since Sat 2024-11-02 18:01:48 CET; 2min 57s ago
TriggeredBy: ‚óè tftp.socket
       Docs: man:in.tftpd
   Main PID: 2403 (in.tftpd)
      Tasks: 1 (limit: 48902)
     Memory: 200.0K
        CPU: 1ms
     CGroup: /system.slice/tftp.service
             ‚îî‚îÄ2403 /usr/sbin/in.tftpd -s /var/lib/tftpboot

Nov 02 18:01:48 centos systemd[1]: Started Tftp Server.
[lucian@centos playbooks]$
[lucian@centos playbooks]$ sudo systemctl status nfs-server
‚óè nfs-server.service - NFS server and services
     Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; enabled; preset: disabled)
    Drop-In: /run/systemd/generator/nfs-server.service.d
             ‚îî‚îÄorder-with-mounts.conf
     Active: active (exited) since Sat 2024-11-02 18:01:52 CET; 2min 57s ago
       Docs: man:rpc.nfsd(8)
             man:exportfs(8)
    Process: 2689 ExecStartPre=/usr/sbin/exportfs -r (code=exited, status=1/FAILURE)
    Process: 2690 ExecStart=/usr/sbin/rpc.nfsd (code=exited, status=0/SUCCESS)
    Process: 2700 ExecStart=/bin/sh -c if systemctl -q is-active gssproxy; then systemctl reload gssproxy ; fi (code=exited, status=0/SUCCESS)
   Main PID: 2700 (code=exited, status=0/SUCCESS)
        CPU: 18ms

Nov 02 18:01:52 centos systemd[1]: Starting NFS server and services...
Nov 02 18:01:52 centos exportfs[2689]: exportfs: Failed to stat /var/nfs/iso: No such file or directory
Nov 02 18:01:52 centos systemd[1]: Finished NFS server and services.
[lucian@centos playbooks]$
[lucian@centos playbooks]$ sudo systemctl status firewalld
‚óè firewalld.service - firewalld - dynamic firewall daemon
     Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; preset: enabled)
     Active: active (running) since Sat 2024-11-02 18:00:47 CET; 4min 5s ago
       Docs: man:firewalld(1)
    Process: 2724 ExecReload=/bin/kill -HUP $MAINPID (code=exited, status=0/SUCCESS)
   Main PID: 706 (firewalld)
      Tasks: 4 (limit: 48902)
     Memory: 46.4M
        CPU: 654ms
     CGroup: /system.slice/firewalld.service
             ‚îî‚îÄ706 /usr/bin/python3 -s /usr/sbin/firewalld --nofork --nopid

Nov 02 18:00:47 centos systemd[1]: Starting firewalld - dynamic firewall daemon...
Nov 02 18:00:47 centos systemd[1]: Started firewalld - dynamic firewall daemon.
Nov 02 18:01:52 centos systemd[1]: Reloading firewalld - dynamic firewall daemon...
Nov 02 18:01:52 centos systemd[1]: Reloaded firewalld - dynamic firewall daemon.
[lucian@centos playbooks]$
[lucian@centos playbooks]$ sudo exportfs -v
/var/nfs/iso    192.168.100.0/24(sync,wdelay,hide,no_subtree_check,sec=sys,ro,secure,no_root_squash,no_all_squash)
[lucian@centos playbooks]$
[lucian@centos playbooks]$ sudo firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth0
  sources:
  services: cockpit dhcp dhcpv6-client nfs ssh tftp
  ports:
  protocols:
  forward: yes
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
[lucian@centos playbooks]$
[lucian@centos playbooks]$ sudo ss -tuln | grep 67
udp   UNCONN 0      0            0.0.0.0:67         0.0.0.0:*
tcp   LISTEN 0      4096         0.0.0.0:56721      0.0.0.0:*
[lucian@centos playbooks]$
[lucian@centos playbooks]$ sudo ss -tuln | grep 69
udp   UNCONN 0      0                  *:69               *:*
[lucian@centos playbooks]$
[lucian@centos playbooks]$ sudo ss -tuln | grep 2049
tcp   LISTEN 0      64           0.0.0.0:2049       0.0.0.0:*
tcp   LISTEN 0      64              [::]:2049          [::]:*
[lucian@centos playbooks]$
[lucian@centos playbooks]$ sudo ss -tuln | grep 111
udp   UNCONN 0      0            0.0.0.0:111        0.0.0.0:*
udp   UNCONN 0      0               [::]:111           [::]:*
tcp   LISTEN 0      4096         0.0.0.0:111        0.0.0.0:*
tcp   LISTEN 0      4096            [::]:111           [::]:*
[lucian@centos playbooks]$
```

# PXE Dateien

Die PXE-bezogenen Dateien befinden sich im **TFTP-Boot-Verzeichnis**, das du in deinem Ansible-Playbook konfiguriert hast. Im Folgenden siehst du, wo sich die Dateien f√ºr die **BIOS**- und **EFI**-Setups befinden:

### Dateipfade f√ºr die PXE-Konfiguration
1. **BIOS PXE-Dateien**
   - **TFTP-Verzeichnis f√ºr BIOS**: `/var/lib/tftpboot`
   - **Konfigurationsverzeichnis f√ºr BIOS**: `/var/lib/tftpboot/pxelinux.cfg`
   - **Wichtige Dateien**:
     - `/var/lib/tftpboot/pxelinux.0`: Der BIOS-Bootloader von Syslinux
     - `/var/lib/tftpboot/pxelinux.cfg/default`: Die Konfigurationsdatei f√ºr das BIOS PXE-Booten

2. **EFI PXE-Dateien**
   - **TFTP-Verzeichnis f√ºr EFI**: `/var/lib/tftpboot/efi/boot`
   - **Wichtige Dateien**:
     - `/var/lib/tftpboot/efi/boot/grubx64.efi`: Der EFI-Bootloader f√ºr 64-Bit-Systeme
     - (Optional) `/var/lib/tftpboot/efi/boot/bootia32.efi`: Der EFI-Bootloader f√ºr 32-Bit-Systeme (falls erforderlich)
     - `/var/lib/tftpboot/efi/boot/grub.cfg`: Die GRUB-Konfigurationsdatei f√ºr das EFI PXE-Booten (m√∂glicherweise musst du diese erstellen, falls sie noch nicht eingerichtet ist)

### So √ºberpr√ºfst du die Verzeichnisstruktur
Um die Dateistruktur zu √ºberpr√ºfen, kannst du den Befehl `tree` verwenden. Falls `tree` nicht installiert ist, kannst du es mit folgendem Befehl installieren:
```bash
sudo yum install tree
```

F√ºhre dann die folgenden Befehle aus, um die Dateistruktur zu inspizieren:

```bash
# BIOS PXE-Dateistruktur √ºberpr√ºfen
tree /var/lib/tftpboot

# EFI PXE-Dateistruktur √ºberpr√ºfen
tree /var/lib/tftpboot/efi/boot
```

```bash
[lucian@centos playbooks]$ tree /var/lib/tftpboot
/var/lib/tftpboot
‚îú‚îÄ‚îÄ efi
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ boot
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ grubx64.efi
‚îú‚îÄ‚îÄ pxelinux.0
‚îî‚îÄ‚îÄ pxelinux.cfg

3 directories, 2 files
```
```bash
[lucian@centos playbooks]$ tree /var/lib/tftpboot/efi/boot
/var/lib/tftpboot/efi/boot
‚îî‚îÄ‚îÄ grubx64.efi

0 directories, 1 file
[lucian@centos playbooks]$
```

### Manuelle √úberpr√ºfung
Du kannst auch `ls` verwenden, um die Dateien manuell aufzulisten:
```bash
# Alle Dateien f√ºr das BIOS PXE-Booten auflisten
ls -l /var/lib/tftpboot
ls -l /var/lib/tftpboot/pxelinux.cfg

# Alle Dateien f√ºr das EFI PXE-Booten auflisten
ls -l /var/lib/tftpboot/efi/boot
```

### Zusammenfassung
- **BIOS PXE-Dateien** befinden sich haupts√§chlich in `/var/lib/tftpboot` und `/var/lib/tftpboot/pxelinux.cfg`.
- **EFI PXE-Dateien** befinden sich in `/var/lib/tftpboot/efi/boot`.

Lass mich wissen, falls du Hilfe beim Verstehen oder Bearbeiten dieser Dateien ben√∂tigst!

# Zwischen BIOS und EFI wechseln

Um sicherzustellen, dass Ihr PXE-Server sowohl **BIOS**- als auch **EFI**-Clients bedienen kann, gibt es bestimmte Konfigurationsdateien, die angepasst werden m√ºssen. Diese Konfigurationen stellen sicher, dass die richtigen Boot-Dateien und Parameter je nach Boot-Modus des Clients bereitgestellt werden.

---

### Konfigurationsdateien f√ºr BIOS und EFI

1. **DHCP-Konfigurationsdatei**: `/etc/dhcp/dhcpd.conf`
   - Diese Datei ist entscheidend, um den Clients mitzuteilen, welchen Bootloader sie basierend auf ihrer Architektur verwenden sollen.
   - Ihre aktuelle Konfiguration sollte bereits sowohl BIOS- als auch EFI-Clients unterst√ºtzen:
     ```conf
     subnet 192.168.100.0 netmask 255.255.255.0 {
       range 192.168.100.100 192.168.100.200;
       option routers 192.168.100.2;

       # BIOS-Clients
       if option arch = 00:00 {
         filename "pxelinux.0";
       }

       # UEFI 32-Bit-Clients
       if option arch = 00:06 {
         filename "bootia32.efi";
       }

       # UEFI 64-Bit-Clients
       if option arch = 00:07 {
         filename "grubx64.efi";
       }
     }
     ```
   - **Anpassungen**: Sie m√ºssen hier normalerweise nichts manuell umstellen. Der DHCP-Server w√§hlt den richtigen Bootloader automatisch basierend auf der Architektur des Clients.

2. **BIOS-Boot-Konfiguration**: `/var/lib/tftpboot/pxelinux.cfg/default`
   - Diese Datei wird verwendet, um PXE-Boot-Optionen f√ºr BIOS-Clients zu konfigurieren.
   - Beispielkonfiguration:
     ```conf
     DEFAULT menu.c32
     PROMPT 0
     TIMEOUT 100
     ONTIMEOUT install

     MENU TITLE PXE Boot Menu
     LABEL install
       MENU LABEL Installiere CentOS
       KERNEL vmlinuz
       APPEND initrd=initrd.img inst.ks=nfs:192.168.100.10:/var/nfs/iso/ks.cfg
     ```
   - **Anpassungen**: Bearbeiten Sie diese Datei, um Boot-Optionen f√ºr BIOS-Clients nach Bedarf zu √§ndern.

3. **EFI-Boot-Konfiguration**: `/var/lib/tftpboot/efi/boot/grub.cfg`
   - Diese Datei wird verwendet, um Boot-Optionen f√ºr EFI-Clients mit GRUB zu konfigurieren.
   - Beispielkonfiguration:
     ```conf
     set timeout=10
     menuentry 'Installiere CentOS' {
       linuxefi /vmlinuz inst.ks=nfs:192.168.100.10:/var/nfs/iso/ks.cfg
       initrdefi /initrd.img
     }
     ```
   - **Anpassungen**: Bearbeiten Sie diese Datei, um Boot-Optionen f√ºr EFI-Clients zu √§ndern.

---

### Zusammenfassung der Datei-Anpassungen
- **DHCP-Konfiguration**: `/etc/dhcp/dhcpd.conf`
  - Stellen Sie sicher, dass die Bedingung f√ºr BIOS- und EFI-Clients vorhanden ist.
- **BIOS-Boot-Konfiguration**: `/var/lib/tftpboot/pxelinux.cfg/default`
  - Diese Datei f√ºr Boot-Optionen von Legacy-BIOS-Clients anpassen.
- **EFI-Boot-Konfiguration**: `/var/lib/tftpboot/efi/boot/grub.cfg`
  - Diese Datei f√ºr Boot-Optionen von UEFI-Clients anpassen.

### Wann sollten Sie diese Dateien anpassen?
- **Um zwischen Konfigurationen zu wechseln**: Es ist nicht notwendig, manuell zwischen BIOS und EFI zu wechseln. Der DHCP-Server und die TFTP-Einrichtung w√§hlen automatisch den richtigen Bootloader basierend auf der Firmware des Clients (BIOS oder EFI).
- **Um Boot-Optionen zu √§ndern**: Falls Sie Kernel-Parameter, Installationsquellen oder Kickstart-Dateipfade √§ndern m√ºssen, bearbeiten Sie die Dateien `pxelinux.cfg/default` f√ºr BIOS-Clients und `grub.cfg` f√ºr EFI-Clients.

# Bereitstellung durch ISO + Automatisierungsdateien

Es sollte grunds√§tzlich m√∂glich sein, alle diese Distributionen mit einer ISO in Kombination mit einer automatisierten Installationsmethode wie **Kickstart**, **Preseed** oder **AutoInstall** √ºber PXE bereitzustellen. Allerdings gibt es einige Besonderheiten und Anforderungen f√ºr jede Distribution:

### Unterst√ºtzung durch ISO + Automatisierungsdateien
1. **CentOS**:
   - **Automatisierungsmethode**: Kickstart
   - **Direkte ISO-Bereitstellung √ºber NFS**: In der Regel gut unterst√ºtzt. Du kannst die ISO direkt bereitstellen und den Kickstart-Pfad in der PXE-Konfiguration angeben.
   - **Beispiel**:
     ```conf
     APPEND initrd=initrd.img inst.ks=nfs:192.168.100.10:/path/to/ks.cfg
     ```

2. **Ubuntu**:
   - **Automatisierungsmethode**: AutoInstall (f√ºr neuere Versionen) oder Preseed (f√ºr √§ltere Versionen)
   - **Direkte ISO-Bereitstellung √ºber NFS**: Ubuntu-Installer k√∂nnen manchmal schwierig sein, und in manchen F√§llen ist es besser, die ISO zu entpacken und die extrahierten Dateien bereitzustellen.
   - **Beispiel**: AutoInstall-Dateien k√∂nnen mit dem `initrd` verkn√ºpft werden, oder du kannst Preseed-Dateien mit √§lteren Installern verwenden.

3. **Fedora**:
   - **Automatisierungsmethode**: Kickstart
   - **Direkte ISO-Bereitstellung √ºber NFS**: √Ñhnlich wie CentOS, unterst√ºtzt Fedora in der Regel die direkte Bereitstellung der ISO.
   - **Beispiel**:
     ```conf
     APPEND initrd=initrd.img inst.ks=nfs:192.168.100.10:/path/to/ks.cfg
     ```

4. **Debian**:
   - **Automatisierungsmethode**: Preseed
   - **Direkte ISO-Bereitstellung √ºber NFS**: Debian-Installer k√∂nnen sowohl die direkte Bereitstellung als auch die Verwendung entpackter Dateien unterst√ºtzen, aber Preseed-Dateien m√ºssen korrekt konfiguriert sein.
   - **Beispiel**:
     ```conf
     APPEND initrd=initrd.img auto=true priority=critical url=nfs:192.168.100.10:/path/to/preseed.cfg
     ```

5. **Kali**:
   - **Automatisierungsmethode**: Preseed (√§hnlich wie Debian)
   - **Direkte ISO-Bereitstellung √ºber NFS**: Kali basiert auf Debian, daher funktionieren Preseed-Dateien √§hnlich. Die Installation k√∂nnte aber einige Anpassungen erfordern.
   - **Beispiel**:
     ```conf
     APPEND initrd=initrd.img auto=true priority=critical url=nfs:192.168.100.10:/path/to/preseed.cfg
     ```

### Zusammenfassung
- **Direkte ISO-Bereitstellung**: Sollte mit den meisten Distributionen klappen, insbesondere mit CentOS und Fedora.
- **Automatisierung**:
  - **Kickstart**: Ideal f√ºr CentOS und Fedora.
  - **Preseed**: Wird f√ºr Debian und Kali verwendet.
  - **AutoInstall**: F√ºr neuere Versionen von Ubuntu.
- **ISO vs. Entpackte Dateien**: Falls Probleme auftreten, kannst du die ISOs entpacken und die Dateien direkt √ºber NFS bereitstellen.

Lass mich wissen, wenn du Hilfe bei der Konfiguration der Automatisierungsdateien f√ºr eine bestimmte Distribution ben√∂tigst oder wenn du auf Schwierigkeiten st√∂√üt!


