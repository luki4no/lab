# PXE Playbook erstellen

```bash
sudo touch ansible-pxe-setup.yml
```
```bash
sudo nano ansible-pxe-setup.yml
```
```yml
---
- hosts: localhost
  become: true
  tasks:
    - name: Install necessary packages
      yum:
        name:
          - dhcp-server
          - tftp-server
          - syslinux
          - httpd
          - vsftpd
        state: present

    - name: Configure DHCP server
      copy:
        dest: /etc/dhcp/dhcpd.conf
        content: |
          option domain-name "localdomain";
          option domain-name-servers 8.8.8.8, 8.8.4.4;
          default-lease-time 600;
          max-lease-time 7200;
          subnet 192.168.100.0 netmask 255.255.255.0 {
            range 192.168.100.100 192.168.100.200;
            option routers 192.168.100.2;
            filename "pxelinux.0";
            next-server 192.168.100.10;
          }

    - name: Configure DHCP interface
      copy:
        dest: /etc/sysconfig/dhcpd
        content: |
          DHCPD_INTERFACE="eth0"  # Replace 'eth0' with the correct interface name
      notify: Restart dhcpd

    - name: Verify DHCP configuration syntax
      command: dhcpd -t -cf /etc/dhcp/dhcpd.conf
      register: dhcpd_config_check
      ignore_errors: true

    - name: Fail if DHCP configuration is invalid
      fail:
        msg: "DHCP configuration file is invalid. Check /etc/dhcp/dhcpd.conf for errors."
      when: dhcpd_config_check.rc != 0

    - name: Enable and start services
      service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - dhcpd
        - tftp
        - httpd
      notify: Reload firewalld

    - name: Create TFTP boot directory
      file:
        path: /var/lib/tftpboot
        state: directory
        mode: '0755'

    - name: Copy PXE boot files
      copy:
        src: /usr/share/syslinux/pxelinux.0
        dest: /var/lib/tftpboot/pxelinux.0

    - name: Configure HTTP server to serve installation media
      shell: |
        mkdir -p /var/www/html/iso/centos
        mkdir -p /var/www/html/iso/debian
        mkdir -p /var/www/html/iso/fedora
        mkdir -p /var/www/html/iso/kali
        mkdir -p /var/www/html/iso/ubuntu

        mount -o loop /home/lucian/iso/CentOS-Stream-9-latest-x86_64-dvd1.iso /var/www/html/iso/centos
        mount -o loop /home/lucian/iso/debian-12.7.0-amd64-netinst.iso /var/www/html/iso/debian
        mount -o loop /home/lucian/iso/Fedora-Everything-netinst-x86_64-40-1.14.iso /var/www/html/iso/fedora
        mount -o loop /home/lucian/iso/kali-linux-2024.3-installer-netinst-amd64.iso /var/www/html/iso/kali
        mount -o loop /home/lucian/iso/ubuntu-24.04.1-live-server-amd64.iso /var/www/html/iso/ubuntu
      args:
        creates: /var/www/html/iso/centos

    - name: Configure firewall
      firewalld:
        service: "{{ item }}"
        permanent: true
        state: enabled
      loop:
        - dhcp
        - tftp
        - http
      notify: Reload firewalld

  handlers:
    - name: Restart dhcpd
      service:
        name: dhcpd
        state: restarted

    - name: Reload firewalld
      service:
        name: firewalld
        state: reloaded
```
`Ctrl+O zum speichern`
`Ctrl+X um zu schliessen`

# PXE Playbook ausführen
```bash
ansible-playbook ansible-pxe-setup.yml --connection=local
```

```bash
[lucian@centos playbooks]$ ansible-playbook ansible-pxe-setup.yml --connection=local

PLAY [localhost] *******************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************
ok: [localhost]

TASK [Install necessary packages] **************************************************************************************
changed: [localhost]

TASK [Configure DHCP server] *******************************************************************************************
changed: [localhost]

TASK [Configure DHCP interface] ****************************************************************************************
changed: [localhost]

TASK [Verify DHCP configuration syntax] ********************************************************************************
changed: [localhost]

TASK [Fail if DHCP configuration is invalid] ***************************************************************************
skipping: [localhost]

TASK [Enable and start services] ***************************************************************************************
changed: [localhost] => (item=dhcpd)
changed: [localhost] => (item=tftp)
changed: [localhost] => (item=httpd)

TASK [Create TFTP boot directory] **************************************************************************************
ok: [localhost]

TASK [Copy PXE boot files] *********************************************************************************************
changed: [localhost]

TASK [Configure HTTP server to serve installation media] ***************************************************************
changed: [localhost]

TASK [Configure firewall] **********************************************************************************************
changed: [localhost] => (item=dhcp)
changed: [localhost] => (item=tftp)
changed: [localhost] => (item=http)

RUNNING HANDLER [Restart dhcpd] ****************************************************************************************
changed: [localhost]

RUNNING HANDLER [Reload firewalld] *************************************************************************************
changed: [localhost]

PLAY RECAP *************************************************************************************************************
localhost                  : ok=12   changed=10   unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

[lucian@centos playbooks]$
```
# Zusammenfassung

Das Playbook wurde erfolgreich ausgeführt. Die Ausgabe zeigt, dass alle Aufgaben ohne Fehler abgeschlossen wurden und die notwendigen Dienste (DHCP, TFTP und HTTP) korrekt gestartet und konfiguriert wurden. Hier eine kurze Zusammenfassung:

- **Fakten sammeln**: Ansible hat Systeminformationen gesammelt, und dies war erfolgreich.
- **Installation der erforderlichen Pakete**: Die Pakete wurden installiert oder als vorhanden bestätigt.
- **DHCP-Server konfigurieren**: Die DHCP-Konfigurationsdatei wurde erstellt oder aktualisiert.
- **DHCP-Schnittstelle konfigurieren**: Die Schnittstelle wurde korrekt für den DHCP-Dienst eingerichtet.
- **DHCP-Konfigurationssyntax überprüfen**: Die DHCP-Konfiguration wurde auf Syntaxfehler überprüft und bestanden.
- **Fehler, wenn DHCP-Konfiguration ungültig ist**: Übersprungen, da die Konfiguration gültig war.
- **Dienste aktivieren und starten**: Alle Dienste (DHCP, TFTP und HTTP) wurden erfolgreich gestartet.
- **TFTP-Boot-Verzeichnis erstellen**: Das Verzeichnis wurde überprüft und ist vorhanden.
- **PXE-Boot-Dateien kopieren**: Die notwendigen PXE-Boot-Dateien wurden kopiert.
- **HTTP-Server für Installationsmedien konfigurieren**: Die Medien wurden eingerichtet und wie erwartet gemountet.
- **Firewall konfigurieren**: Firewall-Regeln wurden angewendet, um den Verkehr für DHCP, TFTP und HTTP zu erlauben.
- **Handler**: Sowohl `dhcpd` als auch `firewalld` wurden bei Bedarf neu gestartet.

### Nächste Schritte
- Du kannst überprüfen, ob die Dienste DHCP, TFTP und HTTP korrekt laufen, indem du ihren Status abfragst:
  ```bash
  sudo systemctl status dhcpd
  ```
    ```bash
  sudo systemctl status tftp
  ```
  ```bash
  sudo systemctl status httpd
  ```

```bash
[lucian@centos playbooks]$ sudo systemctl status dhcpd
● dhcpd.service - DHCPv4 Server Daemon
     Loaded: loaded (/usr/lib/systemd/system/dhcpd.service; enabled; preset: disabled)
     Active: active (running) since Sat 2024-11-02 17:13:18 CET; 3min 12s ago
       Docs: man:dhcpd(8)
             man:dhcpd.conf(5)
   Main PID: 2434 (dhcpd)
     Status: "Dispatching packets..."
      Tasks: 1 (limit: 48902)
     Memory: 4.6M
        CPU: 8ms
     CGroup: /system.slice/dhcpd.service
             └─2434 /usr/sbin/dhcpd -f -cf /etc/dhcp/dhcpd.conf -user dhcpd -group dhcpd --no-pid

Nov 02 17:13:18 centos dhcpd[2434]: Config file: /etc/dhcp/dhcpd.conf
Nov 02 17:13:18 centos dhcpd[2434]: Database file: /var/lib/dhcpd/dhcpd.leases
Nov 02 17:13:18 centos dhcpd[2434]: PID file: /var/run/dhcpd.pid
Nov 02 17:13:18 centos dhcpd[2434]: Source compiled to use binary-leases
Nov 02 17:13:18 centos dhcpd[2434]: Wrote 0 leases to leases file.
Nov 02 17:13:18 centos dhcpd[2434]: Listening on LPF/eth0/00:15:5d:38:01:16/192.168.100.0/24
Nov 02 17:13:18 centos dhcpd[2434]: Sending on   LPF/eth0/00:15:5d:38:01:16/192.168.100.0/24
Nov 02 17:13:18 centos dhcpd[2434]: Sending on   Socket/fallback/fallback-net
Nov 02 17:13:18 centos dhcpd[2434]: Server starting service.
Nov 02 17:13:18 centos systemd[1]: Started DHCPv4 Server Daemon.
[lucian@centos playbooks]$ sudo systemctl status tftp
● tftp.service - Tftp Server
     Loaded: loaded (/usr/lib/systemd/system/tftp.service; indirect; preset: disabled)
     Active: active (running) since Sat 2024-11-02 17:13:16 CET; 3min 18s ago
TriggeredBy: ● tftp.socket
       Docs: man:in.tftpd
   Main PID: 2057 (in.tftpd)
      Tasks: 1 (limit: 48902)
     Memory: 196.0K
        CPU: 1ms
     CGroup: /system.slice/tftp.service
             └─2057 /usr/sbin/in.tftpd -s /var/lib/tftpboot

Nov 02 17:13:16 centos systemd[1]: Started Tftp Server.
[lucian@centos playbooks]$ sudo systemctl status httpd
● httpd.service - The Apache HTTP Server
     Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; preset: disabled)
     Active: active (running) since Sat 2024-11-02 17:13:16 CET; 3min 20s ago
       Docs: man:httpd.service(8)
   Main PID: 2106 (httpd)
     Status: "Total requests: 0; Idle/Busy workers 100/0;Requests/sec: 0; Bytes served/sec:   0 B/sec"
      Tasks: 177 (limit: 48902)
     Memory: 34.0M
        CPU: 199ms
     CGroup: /system.slice/httpd.service
             ├─2106 /usr/sbin/httpd -DFOREGROUND
             ├─2107 /usr/sbin/httpd -DFOREGROUND
             ├─2108 /usr/sbin/httpd -DFOREGROUND
             ├─2109 /usr/sbin/httpd -DFOREGROUND
             └─2110 /usr/sbin/httpd -DFOREGROUND

Nov 02 17:13:16 centos systemd[1]: Starting The Apache HTTP Server...
Nov 02 17:13:16 centos httpd[2106]: AH00558: httpd: Could not reliably determine the server's fully qualified domain na>
Nov 02 17:13:16 centos httpd[2106]: Server configured, listening on: port 80
Nov 02 17:13:16 centos systemd[1]: Started The Apache HTTP Server.
[lucian@centos playbooks]$
```

- **PXE-Boot testen**: Versuche, eine VM über das Netzwerk zu starten, um zu prüfen, ob sie eine IP-Adresse vom DHCP-Server erhält und auf die TFTP- und HTTP-Server zugreifen kann.

Lass mich wissen, ob alles wie erwartet funktioniert oder ob du weitere Unterstützung benötigst!
