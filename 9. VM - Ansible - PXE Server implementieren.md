# PXE Playbook erstellen

```bash
sudo touch ansible-pxe-setup.yml
```
```bash
sudo nano ansible-pxe-setup.yml
```
```yml
---
- hosts: localhost
  become: true
  tasks:
    - name: Install necessary packages
      yum:
        name:
          - dhcp-server
          - tftp-server
          - syslinux
          - httpd
          - vsftpd
        state: present

    - name: Configure DHCP server
      copy:
        dest: /etc/dhcp/dhcpd.conf
        content: |
          option domain-name "localdomain";
          option domain-name-servers 8.8.8.8, 8.8.4.4;
          default-lease-time 600;
          max-lease-time 7200;
          subnet 192.168.100.0 netmask 255.255.255.0 {
            range 192.168.100.100 192.168.100.200;
            option routers 192.168.100.2;
            filename "pxelinux.0";
            next-server 192.168.100.10;
          }

    - name: Configure DHCP interface
      copy:
        dest: /etc/sysconfig/dhcpd
        content: |
          DHCPD_INTERFACE="eth0"  # Replace 'eth0' with the correct interface name
      notify: Restart dhcpd

    - name: Verify DHCP configuration syntax
      command: dhcpd -t -cf /etc/dhcp/dhcpd.conf
      register: dhcpd_config_check
      ignore_errors: true

    - name: Fail if DHCP configuration is invalid
      fail:
        msg: "DHCP configuration file is invalid. Check /etc/dhcp/dhcpd.conf for errors."
      when: dhcpd_config_check.rc != 0

    - name: Enable and start services
      service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - dhcpd
        - tftp
        - httpd
      notify: Reload firewalld

    - name: Create TFTP boot directory
      file:
        path: /var/lib/tftpboot
        state: directory
        mode: '0755'

    - name: Copy PXE boot files
      copy:
        src: /usr/share/syslinux/pxelinux.0
        dest: /var/lib/tftpboot/pxelinux.0

    - name: Configure HTTP server to serve installation media
      shell: |
        mkdir -p /var/www/html/iso/centos
        mkdir -p /var/www/html/iso/debian
        mkdir -p /var/www/html/iso/fedora
        mkdir -p /var/www/html/iso/kali
        mkdir -p /var/www/html/iso/ubuntu

        mount -o loop /home/lucian/iso/CentOS-Stream-9-latest-x86_64-dvd1.iso /var/www/html/iso/centos
        mount -o loop /home/lucian/iso/debian-12.7.0-amd64-netinst.iso /var/www/html/iso/debian
        mount -o loop /home/lucian/iso/Fedora-Everything-netinst-x86_64-40-1.14.iso /var/www/html/iso/fedora
        mount -o loop /home/lucian/iso/kali-linux-2024.3-installer-netinst-amd64.iso /var/www/html/iso/kali
        mount -o loop /home/lucian/iso/ubuntu-24.04.1-live-server-amd64.iso /var/www/html/iso/ubuntu
      args:
        creates: /var/www/html/iso/centos

    - name: Configure firewall
      firewalld:
        service: "{{ item }}"
        permanent: true
        state: enabled
      loop:
        - dhcp
        - tftp
        - http
      notify: Reload firewalld

  handlers:
    - name: Restart dhcpd
      service:
        name: dhcpd
        state: restarted

    - name: Reload firewalld
      service:
        name: firewalld
        state: reloaded
```
`Ctrl+O zum speichern`
`Ctrl+X um zu schliessen`

# PXE Playbook ausführen
```bash
ansible-playbook ansible-pxe-setup.yml --connection=local
```

```bash
[lucian@centos playbooks]$ ansible-playbook ansible-pxe-setup.yml --connection=local

PLAY [localhost] *******************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************
ok: [localhost]

TASK [Install necessary packages] **************************************************************************************
changed: [localhost]

TASK [Configure DHCP server] *******************************************************************************************
changed: [localhost]

TASK [Configure DHCP interface] ****************************************************************************************
changed: [localhost]

TASK [Verify DHCP configuration syntax] ********************************************************************************
changed: [localhost]

TASK [Fail if DHCP configuration is invalid] ***************************************************************************
skipping: [localhost]

TASK [Enable and start services] ***************************************************************************************
changed: [localhost] => (item=dhcpd)
changed: [localhost] => (item=tftp)
changed: [localhost] => (item=httpd)

TASK [Create TFTP boot directory] **************************************************************************************
ok: [localhost]

TASK [Copy PXE boot files] *********************************************************************************************
changed: [localhost]

TASK [Configure HTTP server to serve installation media] ***************************************************************
changed: [localhost]

TASK [Configure firewall] **********************************************************************************************
changed: [localhost] => (item=dhcp)
changed: [localhost] => (item=tftp)
changed: [localhost] => (item=http)

RUNNING HANDLER [Restart dhcpd] ****************************************************************************************
changed: [localhost]

RUNNING HANDLER [Reload firewalld] *************************************************************************************
changed: [localhost]

PLAY RECAP *************************************************************************************************************
localhost                  : ok=12   changed=10   unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

[lucian@centos playbooks]$
```
# Zusammenfassung

Das Playbook wurde erfolgreich ausgeführt. Die Ausgabe zeigt, dass alle Aufgaben ohne Fehler abgeschlossen wurden und die notwendigen Dienste (DHCP, TFTP und HTTP) korrekt gestartet und konfiguriert wurden. Hier eine kurze Zusammenfassung:

- **Fakten sammeln**: Ansible hat Systeminformationen gesammelt, und dies war erfolgreich.
- **Installation der erforderlichen Pakete**: Die Pakete wurden installiert oder als vorhanden bestätigt.
- **DHCP-Server konfigurieren**: Die DHCP-Konfigurationsdatei wurde erstellt oder aktualisiert.
- **DHCP-Schnittstelle konfigurieren**: Die Schnittstelle wurde korrekt für den DHCP-Dienst eingerichtet.
- **DHCP-Konfigurationssyntax überprüfen**: Die DHCP-Konfiguration wurde auf Syntaxfehler überprüft und bestanden.
- **Fehler, wenn DHCP-Konfiguration ungültig ist**: Übersprungen, da die Konfiguration gültig war.
- **Dienste aktivieren und starten**: Alle Dienste (DHCP, TFTP und HTTP) wurden erfolgreich gestartet.
- **TFTP-Boot-Verzeichnis erstellen**: Das Verzeichnis wurde überprüft und ist vorhanden.
- **PXE-Boot-Dateien kopieren**: Die notwendigen PXE-Boot-Dateien wurden kopiert.
- **HTTP-Server für Installationsmedien konfigurieren**: Die Medien wurden eingerichtet und wie erwartet gemountet.
- **Firewall konfigurieren**: Firewall-Regeln wurden angewendet, um den Verkehr für DHCP, TFTP und HTTP zu erlauben.
- **Handler**: Sowohl `dhcpd` als auch `firewalld` wurden bei Bedarf neu gestartet.

### Nächste Schritte
- Du kannst überprüfen, ob die Dienste DHCP, TFTP und HTTP korrekt laufen, indem du ihren Status abfragst:
  ```bash
  sudo systemctl status dhcpd
  ```
    ```bash
  sudo systemctl status tftp
  ```
 ```bash
  sudo systemctl status httpd
  ```

- **PXE-Boot testen**: Versuche, eine VM über das Netzwerk zu starten, um zu prüfen, ob sie eine IP-Adresse vom DHCP-Server erhält und auf die TFTP- und HTTP-Server zugreifen kann.

Lass mich wissen, ob alles wie erwartet funktioniert oder ob du weitere Unterstützung benötigst!
