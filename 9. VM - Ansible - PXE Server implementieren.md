# PXE Playbook erstellen

```bash
sudo touch ansible-pxe-setup.yml
```
```bash
sudo nano ansible-pxe-setup.yml
```
```yml
---
- hosts: localhost
  become: true
  tasks:
    - name: Install necessary packages
      yum:
        name:
          - dhcp-server
          - tftp-server
          - syslinux
          - nfs-utils
        state: present

    - name: Create NFS directories for each distribution and automation files
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /var/nfs/iso
        - /var/nfs/iso/centos
        - /var/nfs/iso/fedora
        - /var/nfs/iso/ubuntu
        - /var/nfs/iso/debian
        - /var/nfs/iso/kali
        - /var/nfs/iso/automation  # Directory for automation files
      notify: Restart nfs

    - name: Create TFTP boot directories for BIOS
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /var/lib/tftpboot
        - /var/lib/tftpboot/pxelinux.cfg
        - /var/lib/tftpboot/centos
        - /var/lib/tftpboot/fedora
        - /var/lib/tftpboot/ubuntu
        - /var/lib/tftpboot/debian
        - /var/lib/tftpboot/kali

    - name: Copy PXE boot files for BIOS
      copy:
        src: /usr/share/syslinux/pxelinux.0
        dest: /var/lib/tftpboot/pxelinux.0

    - name: Copy additional syslinux modules for BIOS boot
      copy:
        src: "{{ item }}"
        dest: /var/lib/tftpboot/
        remote_src: yes
      loop:
        - /usr/share/syslinux/ldlinux.c32
        - /usr/share/syslinux/libcom32.c32
        - /usr/share/syslinux/libutil.c32
        - /usr/share/syslinux/menu.c32

    - name: Create pxelinux.cfg default configuration file for BIOS
      copy:
        dest: /var/lib/tftpboot/pxelinux.cfg/default
        content: |
          DEFAULT menu
          PROMPT 0
          MENU TITLE PXE Boot Menu
          TIMEOUT 600

          LABEL Fedora
            MENU LABEL Install Fedora
            KERNEL /fedora/vmlinuz
            APPEND initrd=/fedora/initrd.img inst.repo=nfs:192.168.100.10:/var/nfs/iso/fedora inst.ks=nfs:192.168.100.10:/var/nfs/iso/automation/ks-fedora-gui.cfg

          LABEL CentOS
            MENU LABEL Install CentOS
            KERNEL /centos/vmlinuz
            APPEND initrd=/centos/initrd.img inst.repo=nfs:192.168.100.10:/var/nfs/iso/centos inst.ks=nfs:192.168.100.10:/var/nfs/iso/automation/ks-centos.cfg

          LABEL Ubuntu
            MENU LABEL Install Ubuntu
            KERNEL /ubuntu/vmlinuz
            APPEND initrd=/ubuntu/initrd.img inst.ks=nfs:192.168.100.10:/var/nfs/iso/automation/ai-ubuntu.yml

          LABEL Debian
            MENU LABEL Install Debian
            KERNEL /debian/vmlinuz
            APPEND initrd=/debian/initrd.img inst.ks=nfs:192.168.100.10:/var/nfs/iso/automation/ps-debian.cfg

          LABEL Kali
            MENU LABEL Install Kali
            KERNEL /kali/vmlinuz
            APPEND initrd=/kali/initrd.img inst.ks=nfs:192.168.100.10:/var/nfs/iso/automation/ps-kali-gui.cfg

    - name: Mount and extract files from CentOS ISO
      block:
        - name: Create mount point for CentOS
          file:
            path: /mnt/centos
            state: directory

        - name: Mount CentOS ISO
          command: mount -o loop /home/lucian/iso/CentOS-Stream-9-latest-x86_64-dvd1.iso /mnt/centos

        - name: Copy initrd.img for CentOS
          copy:
            src: /mnt/centos/isolinux/initrd.img
            dest: /var/nfs/iso/centos/initrd.img
            remote_src: yes

        - name: Copy vmlinuz for CentOS
          copy:
            src: /mnt/centos/isolinux/vmlinuz
            dest: /var/nfs/iso/centos/vmlinuz
            remote_src: yes

        - name: Unmount CentOS ISO
          command: umount /mnt/centos

    - name: Mount and extract files from Fedora ISO
      block:
        - name: Create mount point for Fedora
          file:
            path: /mnt/fedora
            state: directory

        - name: Mount Fedora ISO
          command: mount -o loop /home/lucian/iso/Fedora-Everything-netinst-x86_64-40-1.14.iso /mnt/fedora

        - name: Copy initrd.img for Fedora
          copy:
            src: /mnt/fedora/images/pxeboot/initrd.img
            dest: /var/nfs/iso/fedora/initrd.img
            remote_src: yes

        - name: Copy vmlinuz for Fedora
          copy:
            src: /mnt/fedora/images/pxeboot/vmlinuz
            dest: /var/nfs/iso/fedora/vmlinuz
            remote_src: yes

        - name: Unmount Fedora ISO
          command: umount /mnt/fedora

    - name: Mount and extract files from Ubuntu ISO
      block:
        - name: Create mount point for Ubuntu
          file:
            path: /mnt/ubuntu
            state: directory

        - name: Mount Ubuntu ISO
          command: mount -o loop /home/lucian/iso/ubuntu-24.04.1-live-server-amd64.iso /mnt/ubuntu

        - name: Copy initrd.img for Ubuntu
          copy:
            src: /mnt/ubuntu/casper/initrd
            dest: /var/nfs/iso/ubuntu/initrd.img
            remote_src: yes

        - name: Copy vmlinuz for Ubuntu
          copy:
            src: /mnt/ubuntu/casper/vmlinuz
            dest: /var/nfs/iso/ubuntu/vmlinuz
            remote_src: yes

        - name: Unmount Ubuntu ISO
          command: umount /mnt/ubuntu

    - name: Mount and extract files from Debian ISO
      block:
        - name: Create mount point for Debian
          file:
            path: /mnt/debian
            state: directory

        - name: Mount Debian ISO
          command: mount -o loop /home/lucian/iso/debian-12.7.0-amd64-netinst.iso /mnt/debian

        - name: Copy initrd.img for Debian
          copy:
            src: /mnt/debian/install.amd/initrd.gz
            dest: /var/nfs/iso/debian/initrd.img
            remote_src: yes

        - name: Copy vmlinuz for Debian
          copy:
            src: /mnt/debian/install.amd/vmlinuz
            dest: /var/nfs/iso/debian/vmlinuz
            remote_src: yes

        - name: Unmount Debian ISO
          command: umount /mnt/debian

    - name: Mount and extract files from Kali ISO
      block:
        - name: Create mount point for Kali
          file:
            path: /mnt/kali
            state: directory

        - name: Mount Kali ISO
          command: mount -o loop /home/lucian/iso/kali-linux-2024.3-installer-netinst-amd64.iso /mnt/kali

        - name: Copy initrd.img for Kali
          copy:
            src: /mnt/kali/install.amd/initrd.gz
            dest: /var/nfs/iso/kali/initrd.img
            remote_src: yes

        - name: Copy vmlinuz for Kali
          copy:
            src: /mnt/kali/install.amd/vmlinuz
            dest: /var/nfs/iso/kali/vmlinuz
            remote_src: yes

        - name: Unmount Kali ISO
          command: umount /mnt/kali

    - name: Configure NFS exports
      copy:
        dest: /etc/exports
        content: |
          /var/nfs/iso 192.168.100.0/24(ro,sync,no_root_squash)
      notify: Restart nfs

    - name: Export NFS shares
      command: exportfs -a
      notify: Restart nfs

    - name: Configure DHCP server
      copy:
        dest: /etc/dhcp/dhcpd.conf
        content: |
          option domain-name "localdomain";
          option domain-name-servers 8.8.8.8, 8.8.4.4;
          default-lease-time 600;
          max-lease-time 7200;
          subnet 192.168.100.0 netmask 255.255.255.0 {
            range 192.168.100.100 192.168.100.200;
            option routers 192.168.100.2;
            filename "pxelinux.0";  # BIOS Boot File
          }
      notify: Restart dhcpd

    - name: Configure DHCP interface
      copy:
        dest: /etc/sysconfig/dhcpd
        content: |
          DHCPD_INTERFACE="eth0"  # Replace 'eth0' with the correct interface name
      notify: Restart dhcpd

    - name: Verify DHCP configuration syntax
      command: dhcpd -t -cf /etc/dhcp/dhcpd.conf
      register: dhcpd_config_check
      ignore_errors: true

    - name: Fail if DHCP configuration is invalid
      fail:
        msg: "DHCP configuration file is invalid. Check /etc/dhcp/dhcpd.conf for errors."
      when: dhcpd_config_check.rc != 0

    - name: Enable and start DHCP and TFTP services
      service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - dhcpd
        - tftp
      notify: Reload firewalld

    - name: Enable and start NFS service
      service:
        name: nfs-server
        state: started
        enabled: true
      notify: Reload firewalld

    - name: Configure firewall for PXE-related services
      firewalld:
        service: "{{ item }}"
        permanent: true
        state: enabled
      loop:
        - dhcp
        - tftp
        - nfs
      notify: Reload firewalld

  handlers:
    - name: Restart dhcpd
      service:
        name: dhcpd
        state: restarted

    - name: Restart nfs
      service:
        name: nfs-server
        state: restarted

    - name: Reload firewalld
      service:
        name: firewalld
        state: reloaded
```
`Ctrl+O zum speichern`
`Ctrl+X um zu schliessen`

# PXE Playbook ausführen
```bash
ansible-playbook ansible-pxe-setup.yml --connection=local
```

```bash
[lucian@centos playbooks]$ ansible-playbook ansible-pxe-setup.yml --connection=local

PLAY [localhost] **********************************************************************************************************************

TASK [Gathering Facts] ****************************************************************************************************************
ok: [localhost]

TASK [Install necessary packages] *****************************************************************************************************
changed: [localhost]

TASK [Create NFS directories for each distribution and automation files] **************************************************************
changed: [localhost] => (item=/var/nfs/iso)
changed: [localhost] => (item=/var/nfs/iso/centos)
changed: [localhost] => (item=/var/nfs/iso/fedora)
changed: [localhost] => (item=/var/nfs/iso/ubuntu)
changed: [localhost] => (item=/var/nfs/iso/debian)
changed: [localhost] => (item=/var/nfs/iso/kali)
changed: [localhost] => (item=/var/nfs/iso/automation)

TASK [Create TFTP boot directories for BIOS] ******************************************************************************************
ok: [localhost] => (item=/var/lib/tftpboot)
changed: [localhost] => (item=/var/lib/tftpboot/pxelinux.cfg)
changed: [localhost] => (item=/var/lib/tftpboot/centos)
changed: [localhost] => (item=/var/lib/tftpboot/fedora)
changed: [localhost] => (item=/var/lib/tftpboot/ubuntu)
changed: [localhost] => (item=/var/lib/tftpboot/debian)
changed: [localhost] => (item=/var/lib/tftpboot/kali)

TASK [Copy PXE boot files for BIOS] ***************************************************************************************************
changed: [localhost]

TASK [Copy additional syslinux modules for BIOS boot] *********************************************************************************
changed: [localhost] => (item=/usr/share/syslinux/ldlinux.c32)
changed: [localhost] => (item=/usr/share/syslinux/libcom32.c32)
changed: [localhost] => (item=/usr/share/syslinux/libutil.c32)
changed: [localhost] => (item=/usr/share/syslinux/menu.c32)

TASK [Create pxelinux.cfg default configuration file for BIOS] ************************************************************************
changed: [localhost]

TASK [Create mount point for CentOS] **************************************************************************************************
changed: [localhost]

TASK [Mount CentOS ISO] ***************************************************************************************************************
changed: [localhost]

TASK [Copy initrd.img for CentOS] *****************************************************************************************************
changed: [localhost]

TASK [Copy vmlinuz for CentOS] ********************************************************************************************************
changed: [localhost]

TASK [Unmount CentOS ISO] *************************************************************************************************************
changed: [localhost]

TASK [Create mount point for Fedora] **************************************************************************************************
changed: [localhost]

TASK [Mount Fedora ISO] ***************************************************************************************************************
changed: [localhost]

TASK [Copy initrd.img for Fedora] *****************************************************************************************************
changed: [localhost]

TASK [Copy vmlinuz for Fedora] ********************************************************************************************************
changed: [localhost]

TASK [Unmount Fedora ISO] *************************************************************************************************************
changed: [localhost]

TASK [Create mount point for Ubuntu] **************************************************************************************************
changed: [localhost]

TASK [Mount Ubuntu ISO] ***************************************************************************************************************
changed: [localhost]

TASK [Copy initrd.img for Ubuntu] *****************************************************************************************************
changed: [localhost]

TASK [Copy vmlinuz for Ubuntu] ********************************************************************************************************
changed: [localhost]

TASK [Unmount Ubuntu ISO] *************************************************************************************************************
changed: [localhost]

TASK [Create mount point for Debian] **************************************************************************************************
changed: [localhost]

TASK [Mount Debian ISO] ***************************************************************************************************************
changed: [localhost]

TASK [Copy initrd.img for Debian] *****************************************************************************************************
changed: [localhost]

TASK [Copy vmlinuz for Debian] ********************************************************************************************************
changed: [localhost]

TASK [Unmount Debian ISO] *************************************************************************************************************
changed: [localhost]

TASK [Create mount point for Kali] ****************************************************************************************************
changed: [localhost]

TASK [Mount Kali ISO] *****************************************************************************************************************
changed: [localhost]

TASK [Copy initrd.img for Kali] *******************************************************************************************************
changed: [localhost]

TASK [Copy vmlinuz for Kali] **********************************************************************************************************
changed: [localhost]

TASK [Unmount Kali ISO] ***************************************************************************************************************
changed: [localhost]

TASK [Configure NFS exports] **********************************************************************************************************
changed: [localhost]

TASK [Export NFS shares] **************************************************************************************************************
changed: [localhost]

TASK [Configure DHCP server] **********************************************************************************************************
changed: [localhost]

TASK [Configure DHCP interface] *******************************************************************************************************
changed: [localhost]

TASK [Verify DHCP configuration syntax] ***********************************************************************************************
changed: [localhost]

TASK [Fail if DHCP configuration is invalid] ******************************************************************************************
skipping: [localhost]

TASK [Enable and start DHCP and TFTP services] ****************************************************************************************
changed: [localhost] => (item=dhcpd)
changed: [localhost] => (item=tftp)

TASK [Enable and start NFS service] ***************************************************************************************************
changed: [localhost]

TASK [Configure firewall to allow PXE server related services] ************************************************************************
changed: [localhost] => (item=dhcp)
changed: [localhost] => (item=tftp)
changed: [localhost] => (item=nfs)

RUNNING HANDLER [Restart dhcpd] *******************************************************************************************************
changed: [localhost]

RUNNING HANDLER [Restart nfs] *********************************************************************************************************
changed: [localhost]

RUNNING HANDLER [Reload firewalld] ****************************************************************************************************
changed: [localhost]

PLAY RECAP ****************************************************************************************************************************
localhost                  : ok=43   changed=42   unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

[lucian@centos playbooks]$
```

# Bestätigen

Um sicherzustellen, dass alle Dienste ordnungsgemäß laufen und die Firewall korrekt konfiguriert ist, kannst du die folgenden Schritte auf deinem CentOS-System ausführen:

```bash
sudo yum install tree -y
```
```bash
tree -h /var/lib/tftpboot/
```
```bash
tree -h /var/nfs/iso/
```
```bash
ls -l /home/lucian/iso
```
```bash
sudo systemctl status dhcpd
```
```bash
sudo systemctl status tftp
```
```bash
sudo systemctl status nfs-server
```
```bash
sudo exportfs -v
```
```bash
sudo systemctl status firewalld
```
```bash
sudo firewall-cmd --zone=public --list-all
```
```bash
sudo ss -tuln | grep 67
```
```bash
sudo ss -tuln | grep 69
```
```bash
sudo ss -tuln | grep 2049
```
```bash
sudo ss -tuln | grep 111
```
```bash
cat /var/lib/tftpboot/pxelinux.cfg/default
```

# BIOS oder UEFI?

In unserem Fall wird UEFI bevorzugt, da wir Generation 2 VMs verwenden. Die Konfiguration ist so eingerichtet, dass bei Bedarf zwischen UEFI und BIOS umgeschaltet werden kann.

Um unser PXE-Setup auf **nur BIOS** oder **nur EFI** umzustellen, müssen Sie Änderungen an der `dhcpd.conf`-Datei vornehmen, um festzulegen, welche Boot-Methode verwendet wird. Hier erfahren Sie, wie Sie dies konfigurieren:

---

### Konfiguration für **nur BIOS-Boot**
1. **Öffnen Sie die `/etc/dhcp/dhcpd.conf`-Datei**:
   ```bash
   sudo nano /etc/dhcp/dhcpd.conf
   ```

2. **Passen Sie die Konfiguration an**:
   - Entfernen oder kommentieren Sie die Abschnitte für UEFI-Clients und lassen Sie nur den BIOS-Abschnitt übrig:
   ```conf
   option domain-name "localdomain";
   option domain-name-servers 8.8.8.8, 8.8.4.4;
   default-lease-time 600;
   max-lease-time 7200;
   subnet 192.168.100.0 netmask 255.255.255.0 {
     range 192.168.100.100 192.168.100.200;
     option routers 192.168.100.2;

     # Nur BIOS-Clients
     filename "pxelinux.0";
   }
   ```
   - **Erklärung**: Diese Konfiguration gibt `pxelinux.0` (den BIOS-Bootloader) an alle PXE-Clients aus und deaktiviert die Unterstützung für UEFI.

3. **Starten Sie den DHCP-Dienst neu**:
   ```bash
   sudo systemctl restart dhcpd
   ```

---

### Konfiguration für **nur EFI-Boot**
1. **Öffnen Sie die `/etc/dhcp/dhcpd.conf`-Datei**:
   ```bash
   sudo nano /etc/dhcp/dhcpd.conf
   ```

2. **Passen Sie die Konfiguration an**:
   - Entfernen oder kommentieren Sie den Abschnitt für BIOS-Clients und lassen Sie nur den UEFI-Abschnitt übrig:
   ```conf
   option domain-name "localdomain";
   option domain-name-servers 8.8.8.8, 8.8.4.4;
   default-lease-time 600;
   max-lease-time 7200;
   subnet 192.168.100.0 netmask 255.255.255.0 {
     range 192.168.100.100 192.168.100.200;
     option routers 192.168.100.2;

     # Nur UEFI 64-Bit-Clients
     filename "grubx64.efi";
   }
   ```
   - **Erklärung**: Diese Konfiguration gibt `grubx64.efi` (den EFI-Bootloader) an alle PXE-Clients aus und deaktiviert die Unterstützung für BIOS.

3. **Starten Sie den DHCP-Dienst neu**:
   ```bash
   sudo systemctl restart dhcpd
   ```

---

### Zusammenfassung der Änderungen
- **Für nur BIOS**: Behalten Sie nur die `pxelinux.0`-Konfiguration bei und entfernen oder kommentieren Sie die UEFI-Abschnitte.
- **Für nur EFI**: Behalten Sie nur die `grubx64.efi`-Konfiguration bei und entfernen oder kommentieren Sie den BIOS-Abschnitt.

Mit diesen Anpassungen können Sie steuern, ob Ihr PXE-Server ausschließlich BIOS- oder EFI-Clients unterstützt. Lassen Sie mich wissen, falls Sie weitere Hilfe benötigen!

